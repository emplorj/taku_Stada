<!DOCTYPE html>
<html lang="ja">

<head>
    <meta name="robots" content="noindex">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>卓スタダ</title>
    <link rel="stylesheet" href="style.css">
    <!-- Font Awesomeは全ページで使う可能性があるのでここに残す -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>

<body>
    <button class="hamburger-menu" id="hamburger-menu" aria-label="メニューを開閉する">
        <span></span><span></span><span></span>
    </button>
    <div class="menu-overlay" id="menu-overlay"></div>
    <div id="home-logo-placeholder"></div>
    <canvas id="particleCanvas"></canvas>

    <nav id="tableOfContents" class="side-menu">
        <ul>
            <h2>もくじ</h2>
            <li><a href="#coc-qa-section">CoCシナリオスタダ</a></li>
            <li><a href="#schedule-section">予定</a></li>
            <li><a href="#slides-section">スライド</a></li>
            <li><a href="#archive-section">アーカイブ</a></li>
            <li><a href="#ccfolia-tools-section">ココフォリアツール</a></li>
            <li><a href="tier_list.html">ルールブックオススメTier</a></li>
            <li><a href="q_and_a.html">キャラ質問シート</a></li>
            <li><a href="#content-policy-section">地雷チェックシート</a></li>
            <li><a href="#color-codes-section">TRPGシステム色分け</a></li>
            <li><a href="#yutosheet-template-section">ゆとシートテンプレ</a></li>
        </ul>
    </nav>

    <div class="main-content">
        <header class="main-header">
            <h1>卓スタダ</h1>
            <p class="subtitle">いままでの犯行</p>
        </header>

        <div class="logo-container">
            <img src="img/卓スタダロゴ.png" alt="卓スタダロゴ" class="logo-image">
            <img src="img/卓スタダminiロゴ.png" alt="卓スタダミニロゴ" class="logo-image mini">
        </div>

        <h2 id="coc-qa-section" class="section-title start-title"><a href="CoC_Q&A.html">✨ クトゥルフ神話TRPG シナリオスタダ</a></h2>
        <div class="plain-text-block intro-block">
            <p>クトゥルフ神話TRPGシナリオ作成に悩むあなたへ、<a href="https://twitter.com/haisuikan_trpg" target="_blank"
                    class="plain-text-author-link">はいすいかん(@haisuikan_trpg)</a>さんからのアドバイスをまとめました。</p>
            <p>「どんな神話生物を使えばいいの？」「ストーリーの組み立て方が分からない！」といった疑問を解決し、自作シナリオを回そう！</p>
        </div>

        <div class="plain-text-block additional-info-section">
            <h2 id="schedule-section">予定</h2>
            <ul>
                <li><a href="https://character-sheets.appspot.com/schedule/list?key=ahVzfmNoYXJhY3Rlci1zaGVldHMtbXByHAsSEkRpc2NvcmRTZXNzaW9uRGF0YRimu5y4BQw"
                        target="_blank">デイコード</a>: 予定の入力を行う</li>
            </ul>
            <div id="custom-calendar-container">
                <div class="calendar-nav">
                    <button id="prev-week" title="前の週へ">▲</button>
                    <span id="current-week-display"></span>
                    <button id="next-week" title="次の週へ">▼</button>
                </div>
                <div id="calendar-grid"></div>
            </div>
            <div class="schedule-list-container">
                <h3>今後の予定一覧</h3>
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>イベント名</th>
                            <th>開始予定</th>
                            <th>終了予定</th>
                            <th>GM</th>
                            <th>参加者</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-list-body"></tbody>
                </table>
            </div>
        </div>

        <h1 id="slides-section">卓スタダで用いたスライド</h1>
        <h3 class="start-title" style="background-color: #508040;">はじめよう　クトゥルフ神話RPG</h3>
        <iframe
            src="https://docs.google.com/presentation/d/e/2PACX-1vSOxfzmGJTdTEXXiXOHIxlueVIfbG9Xuq8NSrv0wrgwLUHV84OfLRcyU-I0WjLSXYFfMJEfcubHJ9KR/pubembed?start=false&loop=true&delayms=3000"
            frameborder="0" width="960" height="569" allowfullscreen="true" mozallowfullscreen="true"
            webkitallowfullscreen="true"></iframe>
        <h3 class="start-title" style="background-color: #EA6464;">はじめよう　ソード・ワールド2.5</h3>
        <iframe
            src="https://docs.google.com/presentation/d/e/2PACX-1vTkciQV57Bo7Jzgk85SmrG9JJPMXjaGHYweGxTQhWbeWzD5bKzkcvzBeFQXn1EHwRdM7mHVGpoeI3g4/pubembed?start=false&loop=false&delayms=3000"
            frameborder="0" width="960" height="569" allowfullscreen="true" mozallowfullscreen="true"
            webkitallowfullscreen="true"></iframe>
        <h3 class="start-title" style="background-color: #902222;">はじめよう ダブルクロス3rd</h3>
        <iframe
            src="https://docs.google.com/presentation/d/e/2PACX-1vRwmLeSj3YfrpHtB158EME-vQ1LbzuB3cnVfqAmJkAvcvqvv84Yk7U8dGk8Cjw79WVL7ixOETUosDXU/pubembed?start=false&loop=false&delayms=3000"
            frameborder="0" width="960" height="569" allowfullscreen="true" mozallowfullscreen="true"
            webkitallowfullscreen="true"></iframe>
        <h3 class="start-title" style="background-color: #505050;">はじめよう ネクロニカ</h3>
        <iframe
            src="https://docs.google.com/presentation/d/e/2PACX-1vTTJMqZnvl2aLEbSvDq0lGRIQWkYAL2KsMgworFsdvdzo9KcAiKJtoyhU2Mt6SFZsuZfV7-rMHcd0_U/pubembed?start=false&loop=false&delayms=3000"
            frameborder="0" width="960" height="569" allowfullscreen="true" mozallowfullscreen="true"
            webkitallowfullscreen="true"></iframe>

        <div class="plain-text-block additional-info-section">
            <h2 id="archive-section">◆アーカイブ</h2>
            <ul>
                <li><a href="https://docs.google.com/spreadsheets/d/17wStGJ37GjaINrjZMFZgmacYOPeH9F8ZiahhtJd_nxI/"
                        target="_blank">スプレッドシート</a>: 卓の履歴や、キャラのまとめ、PLの所持ルールブックなんかをここに記す</li>
                <li><a href="https://www.dropbox.com/scl/fo/lnuvslrnsqqyye3ka3dfa/APfMlkTTNNrt9Lgnx5sOOVA?rlkey=t5ltutxf80yqz8p499dae7loj&dl=0"
                        target="_blank">ログ置き場（Dropbox）</a>
                    <p style="font-size: 0.9em; margin-top: 0.3em;">終わったシナリオのログが一元的にみられたらいいねってところ。(Discord: <a
                            href="https://discord.com/channels/641914997894807552/1212090718387044503"
                            target="_blank">該当チャンネル</a>)</p>
                </li>
            </ul>
        </div>

        <div class="plain-text-block additional-info-section">
            <h2 id="char-qa-sheet-section">◆あなたのキャラへの質問一覧シート</h2>
            <ul>
                <li><a href="q_and_a.html">キャラクターQ&Aページ</a>: ここでキャラクターの回答を閲覧・新規登録できます。</li>
                <li><a href="https://docs.google.com/spreadsheets/d/1RJrUdz6QbYc_N1X0gub8zdixEIy_8KyV3exf6A9Smoc/edit?gid=0"
                        target="_blank">Googleスプレッドシート（元データ）</a>: キャラクターへの理解を深めるための質問集です。</li>
            </ul>
        </div>

        <div class="plain-text-block additional-info-section">
            <h2 id="ccfolia-tools-section">◆ココフォリアツール</h2>
            <p>楽屋ココフォリア: <a href="https://ccfolia.com/rooms/6584j5uuj" target="_blank">雑にダイスを振ったり、テストしたりする部屋</a></p>
            <p>キャラシコピペツール（CoC、SW、銀剣など）: <a href="https://kurian.websozai.jp/charaPiece/top" target="_blank">外部サイト</a>
            </p>
            <p>キャラシコピペツール（DX3rd、サタスペ、ネクロニカなど）: <a
                    href="https://script.google.com/macros/s/AKfycbwUPjuiBEGUrfrKcKZCrRAqiB7V687tbA5uxy7PbKxSkgMGnoIMob7yK0PNEvBoUcbTTA/exec"
                    target="_blank">サイト</a></p>
            <p>ダブルクロス コンボジェネレーター: <a
                    href="https://docs.google.com/presentation/d/1ZHHNs_yR37joGYSBiYfQ_C_mwmhdFNHmxkA7fItBkKs/edit#slide=id.g2710a927f4d_0_5"
                    target="_blank">説明スライド</a> / <a
                    href="https://docs.google.com/spreadsheets/d/1jMnjoqxiJZanm6L9-HsXw1crxBdQB_SZQgM4O8Tk7MM/"
                    target="_blank">本体(スプレッドシート)</a></p>
            <p>シナリオテンプレ／CoC（あばれぢから）: <a
                    href="https://docs.google.com/spreadsheets/d/1MifivHkro_g2S_9QFYJoCa4eBaSNw-JqoEexGCEr41w/edit?usp=sharing"
                    target="_blank">スプレッドシート</a></p>
        </div>

        <div class="plain-text-block additional-info-section">
            <h2 id="content-policy-section">地雷チェックシート</h2>
            <p>セッション前に参加者間の認識を合わせるため、弊社では規定のものとして下記シートの使用を推奨しています。</p>
            <ul class="works-list" style="justify-content: flex-start; margin-top: 20px;">
                <li class="works-card">
                    <a href="https://booth.pm/ja/items/3432975" target="_blank">
                        <img src="https://booth.pximg.net/c/300x300_a2_g5/6852d26d-e396-4782-b31c-192ad0dac15b/i/3432975/df64c1c0-d649-43e6-827b-8e8d4a463ad9_base_resized.jpg"
                            alt="細かすぎる地雷チェックシート サムネイル" class="works-thumb">
                        <div class="works-details">
                            <h4 class="works-title">細かすぎる<br>地雷チェックシート</h4>
                            <p class="works-description">これを使うと良い</p>
                        </div>
                    </a>
                </li>
            </ul>
        </div>

        <div class="plain-text-block additional-info-section">
            <h2 id="color-codes-section">スタダのキャラ紹介とかで、共通規格として用いているTRPGシステムと色の組み合わせ</h2>
            <ul class="color-code-list" id="trpg-color-list"></ul>
            <p>Q.普通の青って使わないん？<br>A. その他が青になりがち。</p>
        </div>

        <div class="plain-text-block additional-info-section">
            <h2 id="yutosheet-template-section"><a href="https://yutorize.2-d.jp/" target="_blank">ゆとシート</a>用パーソナル情報テンプレ
            </h2>
            <p>お手持ちのゆとシートの「容姿・経歴」とか「その他」とかの枠にでも付け加えてもらえると助かります<br>
                入れたい情報に沿って、同じ形式で情報を追加してってください（好きなものとか、弱点とか！）</p>
            <div class="code-block-container">
                <pre class="code-block" id="yutosheet-template"><code>[>]**パーソナルデータ
:性別|
:身長|
:体重|
:年齢|
: 髪 |
: 瞳 |
: 肌 |
[---]</code></pre>
                <button class="copy-button" onclick="copyCodeToClipboard('yutosheet-template')">コピー</button>
            </div>
        </div>

        <footer>
            <p>© 2025 卓スタダ.</p>
        </footer>
    </div>

    <button onclick="topFunction()" id="backToTopBtn" title="トップへ戻る">▲</button>
    <script src="common.js"></script>

    <script>
        // ★★★★★ index.html 専用のスクリプトをここに記述 ★★★★★

        document.addEventListener('DOMContentLoaded', function () {
            // --- 色リスト生成 ---
            const colorListContainer = document.getElementById('trpg-color-list');
            if (colorListContainer && typeof TRPG_SYSTEM_COLORS !== 'undefined') {
                const systemsToShow = [
                    { displayName: 'クトゥルフ神話TRPG', colorNameDesc: '緑', systemKey: 'CoC' }, { displayName: 'クトゥルフ神話TRPG(秘匿)', colorNameDesc: '濃緑', systemKey: 'CoC-㊙' },
                    { displayName: 'ソード・ワールド2.5', colorNameDesc: '薄赤', systemKey: 'SW' }, { displayName: 'ダブルクロス The 3rd Edition', colorNameDesc: '赤', systemKey: 'DX3' },
                    { displayName: '永い後日談のネクロニカ', colorNameDesc: '灰', systemKey: 'ネクロニカ' }, { displayName: 'サタスペ', colorNameDesc: 'オレンジ', systemKey: 'サタスペ' },
                    { displayName: 'マモノスクランブル', colorNameDesc: '黄橙', systemKey: 'マモブル' }, { displayName: '銀剣のステラナイツ', colorNameDesc: '暗い青', systemKey: '銀剣' },
                    { displayName: 'ウマ娘TRPG', colorNameDesc: '桃', systemKey: 'ウマ娘' }, { displayName: 'シノビガミ', colorNameDesc: '紫', systemKey: 'シノビガミ' },
                    { displayName: 'アリアンロッドRPG 2E', colorNameDesc: '黄色', systemKey: 'AR' }
                ];
                systemsToShow.forEach(sys => {
                    const colorCode = TRPG_SYSTEM_COLORS[sys.systemKey] || TRPG_SYSTEM_COLORS['default'];
                    const listItem = document.createElement('li');
                    listItem.classList.add('color-list-item');
                    listItem.innerHTML = `<span class="color-list-text">${sys.displayName}：（${sys.colorNameDesc}）</span> <span class="color-chip" style="background-color: ${colorCode};"></span> <code>${colorCode}</code> <button class="copy-color-button" data-colorcode="${colorCode}" title="カラーコードをコピー">コピー</button>`;
                    colorListContainer.appendChild(listItem);
                });
                colorListContainer.addEventListener('click', function (event) {
                    const button = event.target.closest('.copy-color-button');
                    if (button) {
                        navigator.clipboard.writeText(button.dataset.colorcode).then(() => {
                            const originalText = button.textContent; button.textContent = 'OK!'; button.disabled = true;
                            setTimeout(() => { button.textContent = originalText; button.disabled = false; }, 1500);
                        });
                    }
                });
            }

            // --- カレンダー機能の初期化 ---
            if (document.getElementById('custom-calendar-container')) {
                initializeCalendar();
            }
        });

        // --- カレンダー機能の本体 ---
        function initializeCalendar() {
            let allEvents = [];
            let currentStartDate;
            const calendarGrid = document.getElementById('calendar-grid');
            const prevWeekButton = document.getElementById('prev-week');
            const nextWeekButton = document.getElementById('next-week');
            const currentWeekDisplay = document.getElementById('current-week-display');
            const DAYS_IN_WEEK = 7;
            const WEEKS_TO_DISPLAY = 4;
            let tooltipElement;

            async function fetchEventsAndRenderCalendar() {
                const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQhgIEZ9Z_LX8WIuXqb-95vBhYp5-lorvN7EByIaX9krIk1pHUC-253fRW3kFcLeB2nF4MIuvSnOT_H/pub?gid=783716063&single=true&output=csv';
                try {
                    const response = await fetch(SPREADSHEET_URL);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const csvText = await response.text();
                    let parsedEvents = parseGoogleSheetCSV(csvText);
                    const getSeriesKey = (event) => { const participantsKey = event.participants ? [...event.participants].sort().join(',') : ''; return `${(event.eventName || '').trim()}|${(event.system || '').trim()}|${(event.gm || '').trim()}|${participantsKey}`; };
                    const seriesMap = new Map();
                    parsedEvents.forEach(event => { const key = getSeriesKey(event); if (!seriesMap.has(key)) seriesMap.set(key, []); seriesMap.get(key).push(event); });
                    seriesMap.forEach(series => { series.sort((a, b) => a.date.getTime() - b.date.getTime()); const seriesDates = series.map(e => e.date); series.forEach((event, index) => { event.dayInSeries = index + 1; event.seriesDates = seriesDates; event.seriesStartDate = series[0].date; event.seriesEndDate = series[series.length - 1].date; }); });
                    allEvents = mergeConsecutiveEvents(parsedEvents);
                    allEvents.sort((a, b) => a.date.getTime() - b.date.getTime());
                    currentStartDate = getSundayOfGivenDate(new Date());
                    renderCalendar();
                    renderScheduleList(allEvents);
                } catch (error) {
                    console.error("Error fetching or parsing CSV:", error);
                    if (calendarGrid) calendarGrid.innerHTML = "<p>予定の読み込みに失敗しました。</p>";
                }
            }
            function parseGoogleSheetCSV(csvText) {
                const lines = csvText.trim().split('\n'); const events = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].trim().split(',');
                    const normalize = (str) => (typeof str !== 'string' || !str) ? '' : str.replace(/　/g, ' ').trim().replace(/\s+/g, ' ');
                    if (values.length > 3 && values[1] && values[2] && values[3]) {
                        const dateStrRaw = values[1]; const system = normalize(values[2]); const eventName = normalize(values[3]); const gm = normalize(values.length > 4 ? values[4] : '');
                        const participants = [];
                        for (let p_idx = 5; p_idx <= 10; p_idx++) { if (values.length > p_idx && values[p_idx]) { let pName = normalize(values[p_idx].replace(/^"|"$/g, '')); if (pName) participants.push(pName); } }
                        if (!dateStrRaw) continue;
                        const dateOnlyStr = dateStrRaw.split('(')[0].trim(); const parts = dateOnlyStr.split('/'); if (parts.length !== 3) continue;
                        const date = new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
                        if (isNaN(date.getTime())) continue;
                        events.push({ date, endDate: new Date(date), system, eventName, gm, participants });
                    }
                } return events;
            }
            function mergeConsecutiveEvents(events) {
                if (!events || events.length === 0) return [];
                const sortedEvents = [...events].sort((a, b) => a.date.getTime() - b.date.getTime());
                const merged = []; let currentGroup = null;
                for (const event of sortedEvents) {
                    if (currentGroup && currentGroup.system === event.system && currentGroup.eventName === event.eventName && (currentGroup.gm || '') === (event.gm || '') && areParticipantArraysEqual(currentGroup.participants, event.participants) && isNextDay(currentGroup.endDate, event.date)) {
                        currentGroup.endDate = new Date(event.date);
                    } else {
                        if (currentGroup) merged.push(currentGroup);
                        currentGroup = { ...event, endDate: new Date(event.date) };
                    }
                }
                if (currentGroup) merged.push(currentGroup);
                return merged;
            }
            function areParticipantArraysEqual(arr1, arr2) { if (!arr1 && !arr2) return true; if (!arr1 || !arr2 || arr1.length !== arr2.length) return false; const sortedArr1 = [...arr1].sort(); const sortedArr2 = [...arr2].sort(); return sortedArr1.every((value, index) => value === sortedArr2[index]); }
            function isNextDay(date1, date2) { const nextDay = new Date(date1); nextDay.setDate(nextDay.getDate() + 1); return nextDay.getFullYear() === date2.getFullYear() && nextDay.getMonth() === date2.getMonth() && nextDay.getDate() === date2.getDate(); }
            function getSundayOfGivenDate(date) { const newDate = new Date(date); newDate.setDate(newDate.getDate() - newDate.getDay()); newDate.setHours(0, 0, 0, 0); return newDate; }
            function formatDate(date) { return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`; }
            function formatDateToDash(date) { return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; }
            function formatEventPeriod(startDate, endDate) { const sy = startDate.getFullYear(), sm = startDate.getMonth() + 1, sd = startDate.getDate(); const ey = endDate.getFullYear(), em = endDate.getMonth() + 1, ed = endDate.getDate(); const startStr = `${sy}/${sm}/${sd}`; if (sy === ey && sm === em && sd === ed) return startStr; if (sy === ey && sm === em) return `${startStr}-${ed}`; if (sy === ey) return `${startStr}-${em}/${ed}`; return `${startStr}-${ey}/${em}/${ed}`; }
            function getContrastYIQ(hexcolor) { hexcolor = hexcolor.replace("#", ""); const r = parseInt(hexcolor.substr(0, 2), 16), g = parseInt(hexcolor.substr(2, 2), 16), b = parseInt(hexcolor.substr(4, 2), 16); return ((r * 299) + (g * 587) + (b * 114)) / 1000 >= 128 ? '#000000' : '#FFFFFF'; }
            function renderCalendar() {
                if (!calendarGrid || !currentStartDate) return;
                calendarGrid.innerHTML = '';
                const displayEndDate = new Date(currentStartDate); displayEndDate.setDate(currentStartDate.getDate() + (DAYS_IN_WEEK * WEEKS_TO_DISPLAY) - 1);
                if (currentWeekDisplay) currentWeekDisplay.textContent = `${formatDate(currentStartDate)} - ${formatDate(displayEndDate)}`;
                ['日', '月', '火', '水', '木', '金', '土'].forEach((day, index) => { const dayHeader = document.createElement('div'); dayHeader.className = 'calendar-header-cell'; dayHeader.textContent = day; if (index === 0) dayHeader.classList.add('sunday-header'); if (index === 6) dayHeader.classList.add('saturday-header'); calendarGrid.appendChild(dayHeader); });
                let tempDate = new Date(currentStartDate);
                for (let i = 0; i < WEEKS_TO_DISPLAY * DAYS_IN_WEEK; i++) {
                    const cell = document.createElement('div'); cell.className = 'calendar-cell'; cell.dataset.cellDate = formatDateToDash(tempDate);
                    const dateNumberDiv = document.createElement('div'); dateNumberDiv.className = 'date-number'; dateNumberDiv.textContent = tempDate.getDate(); cell.appendChild(dateNumberDiv);
                    const dayOfWeek = tempDate.getDay(); if (dayOfWeek === 0) dateNumberDiv.classList.add('sunday-date-number'); else if (dayOfWeek === 6) dateNumberDiv.classList.add('saturday-date-number');
                    const eventsOnThisDay = allEvents.filter(event => tempDate.getTime() >= event.date.getTime() && tempDate.getTime() <= event.endDate.getTime());
                    if (eventsOnThisDay.length > 0) {
                        const eventsContainer = document.createElement('div'); eventsContainer.className = 'events-container';
                        eventsOnThisDay.forEach(event => {
                            const eventDiv = document.createElement('div'); eventDiv.className = 'event-entry';
                            Object.assign(eventDiv.dataset, { gm: event.gm, participants: event.participants.join(', '), system: event.system, eventName: event.eventName, startDate: formatDateToDash(event.date), endDate: formatDateToDash(event.endDate) });
                            let actualDayInfo = ''; if (event.seriesDates && event.seriesDates.length > 1) { const dayIndex = event.seriesDates.findIndex(d => d.getTime() === tempDate.getTime()); if (dayIndex !== -1) actualDayInfo = `（Day${dayIndex + 1}）`; }
                            eventDiv.dataset.dayInfo = actualDayInfo;
                            const bgColor = TRPG_SYSTEM_COLORS[event.system] || TRPG_SYSTEM_COLORS['default'];
                            eventDiv.textContent = `${event.system}『${event.eventName}』`; Object.assign(eventDiv.style, { backgroundColor: bgColor, color: getContrastYIQ(bgColor), borderLeftColor: bgColor });
                            eventsContainer.appendChild(eventDiv);
                        });
                        cell.appendChild(eventsContainer);
                    }
                    const today = new Date(); today.setHours(0, 0, 0, 0); if (tempDate.getTime() === today.getTime()) { cell.classList.add('today'); dateNumberDiv.classList.add('today-date-number'); }
                    if (tempDate.getTime() < today.getTime()) cell.classList.add('past-date');
                    calendarGrid.appendChild(cell); tempDate.setDate(tempDate.getDate() + 1);
                }
            }
            function renderScheduleList(events) {
                const scheduleBody = document.getElementById('schedule-list-body'); if (!scheduleBody) return;
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const seriesMap = new Map();
                events.forEach(event => { const participantsKey = event.participants ? [...event.participants].sort().join(',') : ''; const seriesKey = `${(event.eventName || '').trim()}|${(event.system || '').trim()}|${(event.gm || '').trim()}|${participantsKey}`; if (!seriesMap.has(seriesKey) && event.seriesEndDate.getTime() >= today.getTime()) { seriesMap.set(seriesKey, { system: event.system, eventName: event.eventName, startDate: event.seriesStartDate, endDate: event.seriesEndDate, gm: event.gm, participants: event.participants }); } });
                const futureSeries = Array.from(seriesMap.values()); futureSeries.sort((a, b) => a.startDate.getTime() - b.startDate.getTime());
                scheduleBody.innerHTML = ''; if (futureSeries.length === 0) { scheduleBody.innerHTML = '<tr><td colspan="5">今後の予定はありません。</td></tr>'; return; }
                const dateFormatter = new Intl.DateTimeFormat('ja-JP', { year: 'numeric', month: 'numeric', day: 'numeric', weekday: 'short' });
                futureSeries.forEach(series => { const row = document.createElement('tr'); const systemColor = TRPG_SYSTEM_COLORS[series.system] || TRPG_SYSTEM_COLORS['default']; const textColor = getContrastYIQ(systemColor); row.innerHTML = `<td><span class="schedule-system-tag" style="background-color:${systemColor}; color:${textColor};">${series.system}</span>『${series.eventName}』</td><td>${dateFormatter.format(series.startDate)}</td><td>${dateFormatter.format(series.endDate)}</td><td>${series.gm || 'N/A'}</td><td>${series.participants.join(', ') || 'N/A'}</td>`; scheduleBody.appendChild(row); });
            }
            function showTooltip(event) {
                const target = event.target.closest('.event-entry'); if (!target) return;
                const { gm, participants: participantsString, dayInfo: dayInfoFromDataset, eventName, system } = target.dataset;
                let seriesMinDate = null, seriesMaxDate = null;
                const targetDate = new Date(target.closest('.calendar-cell').dataset.cellDate + 'T00:00:00');
                const targetParticipantsArray = participantsString ? participantsString.split(', ').map(p => p.trim()) : [];
                const eventBlock = allEvents.find(ev => targetDate.getTime() >= ev.date.getTime() && targetDate.getTime() <= ev.endDate.getTime() && ev.eventName === eventName && ev.system === system && (ev.gm || '') === (gm || '') && areParticipantArraysEqual(ev.participants, targetParticipantsArray));
                if (eventBlock && eventBlock.seriesStartDate && eventBlock.seriesEndDate) { seriesMinDate = eventBlock.seriesStartDate; seriesMaxDate = eventBlock.seriesEndDate; }
                if (!tooltipElement) { tooltipElement = document.createElement('div'); tooltipElement.className = 'event-tooltip'; document.body.appendChild(tooltipElement); }
                let tooltipContent = ''; if (gm) tooltipContent += `<strong>GM:</strong> ${gm}<br>`; if (participantsString) tooltipContent += `<strong>PL:</strong> ${participantsString}<br>`;
                let eventStartDateForTooltip, eventEndDateForTooltip, datesAreValid = false;
                if (seriesMinDate && seriesMaxDate) { [eventStartDateForTooltip, eventEndDateForTooltip, datesAreValid] = [seriesMinDate, seriesMaxDate, true]; }
                if (datesAreValid) { tooltipContent += `<div class="event-duration-info">期間: ${formatEventPeriod(eventStartDateForTooltip, eventEndDateForTooltip)}</div>`; if (dayInfoFromDataset) { const cleanedDayInfo = dayInfoFromDataset.replace(/[（）]/g, ''); if (cleanedDayInfo.trim()) tooltipContent += `<div class="event-day-info">${cleanedDayInfo}</div>`; } }
                tooltipElement.innerHTML = tooltipContent; tooltipElement.style.display = 'block';
            }
            function hideTooltip() { if (tooltipElement) tooltipElement.style.display = 'none'; }
            if (prevWeekButton) prevWeekButton.addEventListener('click', () => { if (currentStartDate) { currentStartDate.setDate(currentStartDate.getDate() - DAYS_IN_WEEK); renderCalendar(); } });
            if (nextWeekButton) nextWeekButton.addEventListener('click', () => { if (currentStartDate) { currentStartDate.setDate(currentStartDate.getDate() + DAYS_IN_WEEK); renderCalendar(); } });
            if (calendarGrid) {
                calendarGrid.addEventListener('mouseover', showTooltip);
                calendarGrid.addEventListener('mouseout', hideTooltip);
                calendarGrid.addEventListener('mousemove', (e) => { if (tooltipElement && tooltipElement.style.display === 'block') { tooltipElement.style.left = `${e.pageX + 15}px`; tooltipElement.style.top = `${e.pageY + 15}px`; } });
            }
            fetchEventsAndRenderCalendar();
        }

        initializeCalendar();

    </script>
</body>

</html>