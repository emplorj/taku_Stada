<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DX3 コンボジェネレーター - 卓スタダ</title>
  <meta name="robots" content="noindex">

  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.css">
  <link rel="stylesheet" href="css/dx3_combo_generator.css">


  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
</head>

<body>
  <div id="header-placeholder"></div>
  <canvas id="particleCanvas"></canvas>

  <div class="main-content">
    <header class="main-header">
      <h1><i class="fa-solid fa-burst"></i> DX3 コンボジェネレーター</h1>
      <p class="subtitle">キャラシのURLを入力して、キャラシから引用することができるぞ！ここを触ってもキャラシに反映されるわけではないから要注意だ！
      </p>
      </p>
    </header>
    <div id="dx3-app" class="plain-text-block" v-cloak @click="closeAllDropdowns">

      <div class="top-info-wrapper">
        <div class="db-sync-container">
          <div class="db-sync-block">
            <label class="db-url-input">
              <span>キャラクターシートURL:</span>
              <input type="text" v-model.trim="characterSheetUrl" placeholder="ゆとシート/Vampire-bloodのURLを入力"
                @keyup.enter="loadFromDb">
            </label>
            <div class="db-buttons">
              <!-- ▼▼▼ ここから追加 ▼▼▼ -->
              <button @click="importFromSheet" class="btn-import" :disabled="isBusy" title="キャラシから引用">
                <i class="fas fa-magic"></i> 引用
              </button>
              <!-- ▲▲▲ ここまで追加 ▲▲▲ -->
              <button @click="loadFromDb" class="btn-load" :disabled="isBusy" title="DBから読込"><i
                  class="fas fa-cloud-download-alt"></i> 読込</button>
              <button @click="overwriteSave" class="btn-save" :disabled="isBusy" title="上書き保存"><i
                  class="fas fa-save"></i>
                保存</button>
              <button @click="deleteFromDb" class="btn-delete" :disabled="isBusy" title="削除"><i
                  class="fas fa-trash-alt"></i> 削除</button>
            </div>
          </div>
          <p v-if="statusMessage" class="status-message" :class="{ 'error': statusIsError }">{{ statusMessage }}</p>
        </div>

        <div class="character-info-grid">
          <label>キャラクター名: <input type="text" v-model="characterName" placeholder="PC名"></label>
          <label>総経験点: <input type="number" v-model.number="totalXp"></label>
          <label>使用経験点: <input type="number" :value="usedXp" readonly class="text-right"></label>
          <label>残経験点: <input type="number" :value="totalXp - usedXp" readonly class="text-right"></label>
        </div>
      </div>

      <h2 class="section-title"><i class="fa-solid fa-bolt"></i> エフェクト <span class="xp-display">(使用経験点: {{ effectXp
          }})</span></h2>
      <div class="table-wrapper">
        <table class="dx3-table effects-table">
          <thead>
            <tr>
              <th>名称</th>
              <th>Lv</th>
              <th>最大Lv</th>
              <th>タイミング</th>
              <th>技能</th>
              <th>難易度</th>
              <th>対象</th>
              <th>射程</th>
              <th>侵蝕値</th>
              <th>制限</th>
              <th>効果</th>
              <th>備考</th>
              <th>設定</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(effect, index) in effects">
              <td><input type="text" v-model="effect.name"></td>
              <td class="text-right"><input type="number" v-model.number="effect.level" min="1" class="text-right"></td>
              <td class="text-right"><input type="number" v-model.number="effect.maxLevel" min="1" class="text-right">
              </td>
              <td><input-with-dropdown v-model="effect.timing" :options="dropdownOptions.timing"></input-with-dropdown>
              </td>
              <td><input-with-dropdown v-model="effect.skill" :options="dropdownOptions.skill"></input-with-dropdown>
              </td>
              <td><input-with-dropdown v-model="effect.difficulty"
                  :options="dropdownOptions.difficulty"></input-with-dropdown></td>
              <td><input-with-dropdown v-model="effect.target" :options="dropdownOptions.target"></input-with-dropdown>
              </td>
              <td><input type="text" v-model="effect.range"></td>
              <td class="text-right"><input type="text" v-model="effect.cost" class="text-right"></td>
              <td><input-with-dropdown v-model="effect.limit" :options="dropdownOptions.limit"></input-with-dropdown>
              </td>
              <td><textarea v-model="effect.effect"></textarea></td>
              <td><textarea v-model="effect.notes"></textarea></td>
              <td class="action-cell">
                <button @click.stop="openEffectPanel($event, effect, 'effect', index)" class="setting-btn" title="詳細設定"
                  :disabled="isEssentialEffect(effect.name)"><i class="fa-solid fa-gear"></i></button>
                <button @click="removeEffect(index)" class="delete-btn" title="削除"
                  :disabled="isEssentialEffect(effect.name)"><i class="fa-solid fa-trash"></i></button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <button @click="addEffect" class="add-btn"><i class="fa-solid fa-plus"></i> エフェクトを追加</button>

      <h2 class="section-title"><i class="fa-solid fa-star"></i> イージーエフェクト <span class="xp-display">(使用経験点: {{
          easyEffectXp }})</span></h2>
      <div class="table-wrapper">
        <table class="dx3-table effects-table">
          <thead>
            <tr>
              <th>名称</th>
              <th>Lv</th>
              <th>最大Lv</th>
              <th>タイミング</th>
              <th>技能</th>
              <th>難易度</th>
              <th>対象</th>
              <th>射程</th>
              <th>侵蝕値</th>
              <th>制限</th>
              <th>効果</th>
              <th>備考</th>
              <th>設定</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(ee, index) in easyEffects">
              <td><input type="text" v-model="ee.name"></td>
              <td class="text-right"><input type="number" v-model.number="ee.level" min="1" class="text-right"></td>
              <td class="text-right"><input type="number" v-model.number="ee.maxLevel" min="1" class="text-right"></td>
              <td><input-with-dropdown v-model="ee.timing" :options="dropdownOptions.timing"></input-with-dropdown></td>
              <td><input-with-dropdown v-model="ee.skill" :options="dropdownOptions.skill"></input-with-dropdown></td>
              <td><input-with-dropdown v-model="ee.difficulty"
                  :options="dropdownOptions.difficulty"></input-with-dropdown></td>
              <td><input-with-dropdown v-model="ee.target" :options="dropdownOptions.target"></input-with-dropdown></td>
              <td><input type="text" v-model="ee.range"></td>
              <td class="text-right"><input type="text" v-model="ee.cost" class="text-right"></td>
              <td><input-with-dropdown v-model="ee.limit" :options="dropdownOptions.limit"></input-with-dropdown></td>
              <td><textarea v-model="ee.effect"></textarea></td>
              <td><textarea v-model="ee.notes"></textarea></td>
              <td class="action-cell">
                <button @click.stop="openEffectPanel($event, ee, 'easy', index)" class="setting-btn" title="詳細設定"><i
                    class="fa-solid fa-gear"></i></button>
                <button @click="removeEasyEffect(index)" class="delete-btn" title="削除"><i
                    class="fa-solid fa-trash"></i></button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <button @click="addEasyEffect" class="add-btn"><i class="fa-solid fa-plus"></i> イージーエフェクトを追加</button>

      <h2 class="section-title"><i class="fa-solid fa-cubes-stacked"></i> コンボデータ</h2>
      <div v-for="(combo, index) in processedCombos" class="combo-block">
        <div class="combo-header">
          <input type="text" v-model="combos[index].name" class="combo-name-input">
          <label class="combo-level-select">
            コンボLv:
            <select v-model.number="combos[index].comboLevelBonus">
              <option v-for="n in 6" :value="n-1">+{{ n-1 }}</option>
            </select>
          </label>
          <button @click="removeCombo(index)" class="delete-btn"><i class="fa-solid fa-trash"></i></button>
        </div>

        <div class="combo-stats-bar">
          <div class="stat-item" :title="combo.diceBreakdown">ダイス: {{ combo.totalDice }}</div>
          <div class="stat-item" :title="combo.critBreakdown">C値: {{ combo.finalCrit }}</div>
          <div class="stat-item" :title="combo.achieveBreakdown">達成値: +{{ combo.totalAchieve }}</div>
          <div class="stat-item weapon-atk-input">武器ATK: <input type="number" v-model.number="combos[index].atk_weapon">
          </div>
          <div class="stat-item" :title="combo.atkBreakdown">ATK: {{ combo.totalAtk }}</div>
          <div class="stat-item" :title="combo.costBreakdown">侵蝕値: {{ combo.totalCost }}</div>
        </div>

        <button @click="openEffectSelectModal(index)" class="effect-select-button">
          <i class="fa-solid fa-check-double"></i> 組合せ ({{ combos[index].effectNames.length }}件選択中): {{
          combo.compositionText }}
        </button>

        <div class="combo-details-grid">
          <div class="combo-textarea-wrapper">
            <div class="textarea-header">
              <label>フレーバーテキスト</label>
            </div>
            <textarea v-model="combos[index].flavor" placeholder="例: 相手を焼き尽くす。"></textarea>
          </div>
          <div class="combo-textarea-wrapper">
            <div class="textarea-header">
              <label>効果解説</label>
              <div class="mode-toggle">
                <button @click="combos[index].effectDescriptionMode = 'auto'"
                  :class="{active: combos[index].effectDescriptionMode === 'auto'}">自動転記</button>
                <button @click="switchToManualMode(combos[index], index)"
                  :class="{active: combos[index].effectDescriptionMode === 'manual'}">手動編集</button>
              </div>
            </div>
            <textarea v-if="combos[index].effectDescriptionMode === 'manual'"
              v-model="combos[index].manualEffectDescription" placeholder="ここに独自の効果解説を入力"></textarea>
            <textarea v-else readonly :value="combo.autoEffectText"></textarea>
          </div>
        </div>

        <div class="combo-palette-display">
          <div class="copy-container">
            <textarea readonly :value="combo.chatPalette"></textarea>
            <button @click="copyToClipboard(combo.chatPalette, $event)"><i class="fa-solid fa-paste"></i></button>
          </div>
        </div>
      </div>
      <button @click="addCombo" class="add-btn"><i class="fa-solid fa-plus"></i> コンボを追加</button>

      <!-- Effect Details Floating Panel -->
      <div v-if="isPanelOpen" class="floating-panel" :style="panelStyle" @click.stop>
        <div class="panel-header">
          <h3>{{ editingEffect.name || '新規' }} 詳細設定</h3>
          <button @click="closeEffectPanel" class="close-btn">×</button>
        </div>
        <div class="panel-body">
          <div class="modal-tabs">
            <button v-for="tab in modalTabs" :key="tab.key" :class="{ active: activeModalTab === tab.key }"
              @click="activeModalTab = tab.key">{{ tab.label }}</button>
          </div>
          <div class="modal-tab-content">
            <div v-show="activeModalTab !== 'crit'" class="panel-grid">
              <div class="input-group">
                <label>{{ activeModalTabLabel }} 基本値: <span class="input-example">(例: <span
                      class="color-base">+X</span>)</span></label>
                <input type="number" v-model.number="editingEffect.values[activeModalTab].base">
              </div>
              <div class="input-group">
                <label>{{ activeModalTabLabel }} Lv毎加算: <span class="input-example">(例: <span
                      class="color-per-level">LV×N</span>)</span></label>
                <input type="number" v-model.number="editingEffect.values[activeModalTab].perLevel">
              </div>
            </div>
            <div v-show="activeModalTab === 'crit'">
              <div class="input-group">
                <label>C値 基本値:</label>
                <input type="number" v-model.number="editingEffect.values.crit.base">
              </div>
              <div class="input-group">
                <label>C値 Lv毎減算:</label>
                <input type="number" v-model.number="editingEffect.values.crit.perLevel">
              </div>
              <div class="input-group">
                <label>C値 下限:</label>
                <input type="number" v-model.number="editingEffect.values.crit.min">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Effect Selection Modal -->
      <div v-if="isEffectSelectModalOpen" class="modal-overlay" @click.self="cancelEffectSelection">
        <div class="modal-content effect-select-modal">
          <div class="modal-header">
            <h3>コンボのエフェクトを選択</h3>
            <button @click="cancelEffectSelection" class="close-btn">×</button>
          </div>
          <div class="modal-body">
            <div class="option-group">
              <strong>エフェクト</strong>
              <label v-for="effect in effects" :key="effect.name + editingComboIndex + 'effect-select'"
                :class="{disabled: isEffectDisabled(effect)}">
                <input type="checkbox" :value="effect.name" v-model="tempSelectedEffectNames"
                  :disabled="isEffectDisabled(effect)"> {{ effect.name }} ({{ effect.timing }})
              </label>
            </div>
            <div class="option-group">
              <strong>イージーエフェクト</strong>
              <label v-for="ee in easyEffects" :key="ee.name + editingComboIndex + 'ee-select'"
                :class="{disabled: isEffectDisabled(ee)}">
                <input type="checkbox" :value="ee.name" v-model="tempSelectedEffectNames"
                  :disabled="isEffectDisabled(ee)"> {{ ee.name }} ({{ ee.timing }})
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button @click="cancelEffectSelection" class="cancel-btn">キャンセル</button>
            <button @click="confirmEffectSelection">決定</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <button onclick="topFunction()" id="backToTopBtn" title="トップへ戻る">▲</button>
  <script src="js/common.js"></script>

  <script type="text/x-template" id="input-with-dropdown-template">
    <div class="input-with-dropdown" @click.stop>
      <input type="text" :value="value" @input="handleInput">
      <span class="dropdown-arrow" @click.prevent.stop="toggleDropdown" v-if="options.length > 0">▼</span>
      <ul v-if="isOpen && options.length > 0" class="dropdown-menu">
        <li v-for="option in options" :key="option" @click="selectOption(option)">
          {{ option }}
        </li>
      </ul>
    </div>
  </script>

  <script src="js/dx3_combo_generator.js"></script>
</body>

</html>