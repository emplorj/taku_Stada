<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DX3 コンボジェネレーター - 卓スタダ</title>
  <meta name="robots" content="noindex">

  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.css">
  <link rel="stylesheet" href="css/dx3_combo_generator.css">

  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
</head>

<body>
  <div id="header-placeholder"></div>
  <canvas id="particleCanvas"></canvas>

  <div class="main-content">
    <header class="main-header">
      <h1><i class="fa-solid fa-burst"></i> DX3 コンボジェネレーター</h1>
      <p class="subtitle">キャラシのURLを入力して、キャラシから引用することができるぞ！ここを触ってもキャラシに反映されるわけではないから要注意だ！</p>
    </header>

    <!-- ★★★ ここから使い方ガイドを追加 ★★★ -->
    <details class="usage-guide plain-text-block">
      <summary>
        <div class="summary-content">
          <h2>DX3コンボジェネレーター究極ガイド！</h2>
          <p class="subtitle">キャラシURLを貼って色々調整することで、簡単にコピーできるコンボが爆誕するぞ！</p>
        </div>
      </summary>
      <p>
        面倒なコンボ計算やチャットパレットの整形はもう終わりだ！<br>このツールを使えば、君のキャラクターシートURLを貼り付けるだけで、<strong>魔法のようにデータが読み込まれ</strong>、直感的な操作でオリジナルのコンボが<strong>爆速で完成するぞ！</strong>
      </p>
      <p>さあ、君もこのツールの真の力を解放しよう！</p>

      <h3>まずはここから！爆速3ステップでコンボを使いこなすぞ！</h3>
      <h4>STEP 1: まずはキャラシを丸ごと引用するぞ！</h4>
      <ol>
        <li>画面上の<strong>「キャラクターシートURL」</strong>欄に、君のキャラシ（ゆとシート/キャラクター保管所）のURLをペタッと貼り付けよう！</li>
        <li><strong>「<i class="fas fa-magic"></i> 引用」</strong>ボタンを叩け！</li>
        <li>「このデータでOK？」と聞かれるから、内容を確認して「OK」！<br>これだけで、君のエフェクトやアイテムがリストにずらりと並ぶんだ。すごいだろ！</li>
      </ol>

      <h4>STEP 2: 最強のコンボを組み立てるぞ！</h4>
      <ol>
        <li><strong>「<i class="fa-solid fa-plus"></i> コンボを追加」</strong>ボタンで、新しいコンボのキャンバスを用意しよう。</li>
        <li><strong>「<i class="fa-solid fa-check-double"></i>
            組合せ」</strong>ボタンから、今回のコンボで使いたいエフェクトやアイテムを選ぶんだ。チェックを入れるだけでOKだぞ！</li>
        <li>コンボ計算バーの<strong>「技能値」</strong>を設定しよう。使ったエフェクトから最適なものが自動で選ばれるけど、エフェクトによって変更されるなら変更してもいい。能力値ボーナスも忘れず入力だ！</li>
      </ol>

      <h4>STEP 3: 出来上がったチャットパレットをコピーするだけ！</h4>
      <ol>
        <li>コンボブロックの下を見ろ！そこにはもう、<strong>完璧に整形されたチャットパレット</strong>が生成されているぞ！</li>
        <li>右上の<strong>コピーボタン<i class="fa-solid fa-paste"></i></strong> をワンクリック！</li>
        <li>あとはココフォリアに貼り付けるだけ！簡単だな！</li>
      </ol>

      <h3>もっと使いこなすための機能紹介だ！</h3>
      <p>このツールの真価はこれだけじゃないぞ！もっとディープな機能を見ていこう！</p>

      <h4><i class="fa-solid fa-database"></i> 君だけのコンボデータを保存・管理できるぞ！</h4>
      <ul>
        <li><strong>「<i class="fas fa-save"></i> 保存」</strong>: 作り上げた珠玉のコンボデータを、データベースに安全に保存できるぞ！もうデータが消える心配はない！
        </li>
        <li><strong>「<i class="fas fa-cloud-download-alt"></i> 読込」</strong>: 保存したデータをいつでも一瞬で呼び出せる！セッション直前の準備もラクラクだ。</li>
      </ul>
      <h4><i class="fa-solid fa-gear"></i> 「詳細設定」で計算をハックしよう！</h4>
      <ul>
        <li>エフェクトやアイテムの横にある<strong>歯車ボタン<i class="fa-solid fa-gear"></i></strong> を押してみよう。</li>
        <li>「このエフェクトはダイスを+5する」「このアイテムはC値を-1する」…そんな<strong>コンボ計算の効果</strong>を設定できるんだ！設定したら、コンボデータに反映されるぞ！</li>
      </ul>
      <h4><i class="fa-solid fa-wand-magic-sparkles"></i> 驚異の自動計算＆カスタマイズ機能！</h4>
      <ul>
        <li><strong>コンボ計算バー</strong>: ダイス、C値、達成値、侵蝕値…面倒な計算は<strong>すべてリアルタイムで自動計算</strong>されるぞ！<i
            class="fa-solid fa-gear"></i> 「詳細設定」にデータをいれておこう。
        </li>
        <li><strong>対象・射程</strong>: エフェクトの効果から、ツールが賢く「対象」と「射程」を自動で判断してくれるんだ。もちろん、「手動」に切り替えて君の好きなように書き換えることだって可能だ！</li>
        <li><strong>効果解説もガチえぐい！</strong>:
          <ul>
            <li>「自動転記」なら、選んだエフェクトの効果をいい感じにまとめてくれる！</li>
            <li>
              <strong>「解説のLvを自動計算」</strong>にチェックを入れれば、<code>+[LV*3]</code>のような記述を、<strong>今のレベルで自動計算</strong>してくれるんだ！[]でLv囲むことを忘れるな！Lv3だったら、+9として扱ってくれるぞ！
            </li>
          </ul>
        </li>
      </ul>
      <p>さあ、このツールで君だけの最強コンボを生み出し、セッションで大活躍するんだ！</p>
    </details>
    <!-- ★★★ 使い方ガイドここまで ★★★ -->

    <script type="text/x-template" id="input-with-dropdown-template">
      <div class="input-with-dropdown" @click.stop>
        <input type="text" :value="value" @input="handleInput">
        <span class="dropdown-arrow" @click.prevent.stop="toggleDropdown($event)" v-if="options.length > 0">▼</span>
        <ul v-if="isOpen && options.length > 0" class="dropdown-menu" :style="dropdownStyle">
          <li v-for="option in options" :key="option" @click="selectOption(option)">
            {{ option }}
          </li>
        </ul>
      </div>
    </script>

    <div id="dx3-app" class="plain-text-block" v-cloak @click="closeAllDropdowns">

      <div class="top-info-wrapper">
        <div class="db-sync-container">
          <div class="db-sync-block">
            <label class="db-url-input">
              <span>キャラクターシートURL:</span>
              <input type="text" v-model.trim="characterSheetUrl" placeholder="ゆとシート/Vampire-bloodのURLを入力"
                @keyup.enter="importFromSheet">
            </label>
            <div class="db-buttons">
              <button @click="importFromSheet" class="btn-import" :disabled="isBusy" title="キャラシから引用"><i
                  class="fas fa-magic"></i> 引用</button>
              <button @click="loadFromDb" class="btn-load" :disabled="isBusy" title="DBから読込"><i
                  class="fas fa-cloud-download-alt"></i> 読込</button>
              <button @click="overwriteSave" class="btn-save" :disabled="isBusy" title="上書き保存"><i
                  class="fas fa-save"></i> 保存</button>
              <button @click="deleteFromDb" class="btn-delete" :disabled="isBusy" title="削除"><i
                  class="fas fa-trash-alt"></i> 削除</button>
            </div>
          </div>
          <p v-if="statusMessage" class="status-message" :class="{ 'error': statusIsError }">{{ statusMessage }}</p>
        </div>
        <div class="character-info-grid">
          <label>キャラクター名: <input type="text" v-model="characterName" placeholder="PC名"></label>
          <label>総経験点: <input type="number" v-model.number="totalXp"></label>
          <label>使用経験点: <input type="number" :value="usedXp" readonly class="text-right"></label>
          <label>残経験点: <input type="number" :value="totalXp - usedXp" readonly class="text-right"></label>
        </div>
      </div>

      <h2 class="section-title"><i class="fa-solid fa-bolt"></i> エフェクト <span class="xp-display">(使用経験点: {{ effectXp
          }})</span></h2>
      <div class="table-wrapper">
        <table class="dx3-table effects-table">
          <thead>
            <tr>
              <th>名称</th>
              <th>Lv</th>
              <th>最大Lv</th>
              <th>タイミング</th>
              <th>技能</th>
              <th>難易度</th>
              <th>対象</th>
              <th>射程</th>
              <th>侵蝕値</th>
              <th>制限</th>
              <th>効果</th>
              <th>備考</th>
              <th>設定</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(effect, index) in effects">
              <td><input type="text" v-model="effect.name"></td>
              <td class="text-right"><input type="number" v-model.number="effect.level" min="1" class="text-right"></td>
              <td class="text-right"><input type="number" v-model.number="effect.maxLevel" min="1" class="text-right">
              </td>
              <td><input-with-dropdown v-model="effect.timing" :options="dropdownOptions.timing"></input-with-dropdown>
              </td>
              <td><input-with-dropdown v-model="effect.skill" :options="dropdownOptions.skill"></input-with-dropdown>
              </td>
              <td><input-with-dropdown v-model="effect.difficulty"
                  :options="dropdownOptions.difficulty"></input-with-dropdown></td>
              <td><input-with-dropdown v-model="effect.target" :options="dropdownOptions.target"></input-with-dropdown>
              </td>
              <td><input type="text" v-model="effect.range"></td>
              <td class="text-right"><input type="text" v-model="effect.cost" class="text-right"></td>
              <td><input-with-dropdown v-model="effect.limit" :options="dropdownOptions.limit"></input-with-dropdown>
              </td>
              <td><textarea v-model="effect.effect"></textarea></td>
              <td><textarea v-model="effect.notes"></textarea></td>
              <td class="action-cell">
                <button @click.stop="openEffectPanel($event, effect, 'effect', index)" class="setting-btn" title="詳細設定"
                  :disabled="isEssentialEffect(effect.name)"><i class="fa-solid fa-gear"></i></button>
                <button @click="removeEffect(index)" class="delete-btn" title="削除"
                  :disabled="isEssentialEffect(effect.name)"><i class="fa-solid fa-trash"></i></button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <button @click="addEffect" class="add-btn"><i class="fa-solid fa-plus"></i> エフェクトを追加</button>

      <h2 class="section-title"><i class="fa-solid fa-star"></i> イージーエフェクト <span class="xp-display">(使用経験点: {{
          easyEffectXp }})</span></h2>
      <div class="table-wrapper">
        <table class="dx3-table effects-table">
          <thead>
            <tr>
              <th>名称</th>
              <th>Lv</th>
              <th>最大Lv</th>
              <th>タイミング</th>
              <th>技能</th>
              <th>難易度</th>
              <th>対象</th>
              <th>射程</th>
              <th>侵蝕値</th>
              <th>制限</th>
              <th>効果</th>
              <th>備考</th>
              <th>設定</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(ee, index) in easyEffects">
              <td><input type="text" v-model="ee.name"></td>
              <td class="text-right"><input type="number" v-model.number="ee.level" min="1" class="text-right"></td>
              <td class="text-right"><input type="number" v-model.number="ee.maxLevel" min="1" class="text-right"></td>
              <td><input-with-dropdown v-model="ee.timing" :options="dropdownOptions.timing"></input-with-dropdown></td>
              <td><input-with-dropdown v-model="ee.skill" :options="dropdownOptions.skill"></input-with-dropdown></td>
              <td><input-with-dropdown v-model="ee.difficulty"
                  :options="dropdownOptions.difficulty"></input-with-dropdown></td>
              <td><input-with-dropdown v-model="ee.target" :options="dropdownOptions.target"></input-with-dropdown></td>
              <td><input type="text" v-model="ee.range"></td>
              <td class="text-right"><input type="text" v-model="ee.cost" class="text-right"></td>
              <td><input-with-dropdown v-model="ee.limit" :options="dropdownOptions.limit"></input-with-dropdown></td>
              <td><textarea v-model="ee.effect"></textarea></td>
              <td><textarea v-model="ee.notes"></textarea></td>
              <td class="action-cell">
                <button @click.stop="openEffectPanel($event, ee, 'easy', index)" class="setting-btn" title="詳細設定"><i
                    class="fa-solid fa-gear"></i></button>
                <button @click="removeEasyEffect(index)" class="delete-btn" title="削除"><i
                    class="fa-solid fa-trash"></i></button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <button @click="addEasyEffect" class="add-btn"><i class="fa-solid fa-plus"></i> イージーエフェクトを追加</button>

      <h2 class="section-title"><i class="fa-solid fa-shield-halved"></i> アイテム <span class="xp-display">(使用経験点: {{
          itemXp }})</span></h2>
      <div class="table-wrapper">
        <table class="dx3-table items-table">
          <thead>
            <tr>
              <th>名称</th>
              <th>Lv</th>
              <th>種別</th>
              <th>技能</th>
              <th>命中</th>
              <th>攻撃力</th>
              <th>ガード値</th>
              <th>射程</th>
              <th>侵蝕値</th>
              <th>経験点</th>
              <th>備考</th>
              <th>設定</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(item, index) in items">
              <td><input type="text" v-model="item.name"></td>
              <td class="text-right"><input type="number" v-model.number="item.level" min="1" class="text-right"></td>
              <td><input type="text" v-model="item.type"></td>
              <td><input-with-dropdown v-model="item.skill" :options="dropdownOptions.skill"></input-with-dropdown></td>
              <td><input type="text" v-model="item.accuracy" class="text-right"></td>
              <td><input type="text" v-model="item.attack" class="text-right"></td>
              <td><input type="text" v-model="item.guard" class="text-right"></td>
              <td><input type="text" v-model="item.range"></td>
              <td class="text-right"><input type="text" v-model="item.cost" class="text-right"></td>
              <td class="text-right"><input type="number" v-model.number="item.xp" class="text-right"></td>
              <td><textarea v-model="item.notes"></textarea></td>
              <td class="action-cell">
                <button @click.stop="openEffectPanel($event, item, 'item', index)" class="setting-btn" title="詳細設定"><i
                    class="fa-solid fa-gear"></i></button>
                <button @click="removeItem(index)" class="delete-btn" title="削除"><i
                    class="fa-solid fa-trash"></i></button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <button @click.stop="addItem" class="add-btn"><i class="fa-solid fa-plus"></i> アイテムを追加</button>

      <h2 class="section-title"><i class="fa-solid fa-cubes-stacked"></i> コンボデータ</h2>
      <div v-for="(combo, index) in processedCombos" class="combo-block">
        <div class="combo-header">
          <input type="text" v-model="combos[index].name" class="combo-name-input">
          <label class="combo-level-select">コンボLv:<select v-model.number="combos[index].comboLevelBonus">
              <option v-for="n in 6" :value="n-1">+{{ n-1 }}</option>
            </select></label>
          <button @click="removeCombo(index)" class="delete-btn"><i class="fa-solid fa-trash"></i></button>
        </div>
        <div class="combo-stats-bar">
          <div class="stat-item" :title="combo.diceBreakdown">ダイス: {{ combo.totalDice }}</div>
          <div class="stat-item" :title="combo.critBreakdown">C値: {{ combo.finalCrit }}</div>
          <div class="stat-item" :title="combo.achieveBreakdown">達成値: +{{ combo.totalAchieve }}</div>
          <div class="stat-item target-setting">
            <span>対象: <input type="text"
                :value="combos[index].targetMode === 'auto' ? combo.target : combos[index].manualTarget"
                :readonly="combos[index].targetMode === 'auto'"
                @input="combos[index].manualTarget = $event.target.value" class="manual-input"></span>
            <div class="mode-toggle">
              <button @click="combos[index].targetMode = 'auto'"
                :class="{active: combos[index].targetMode === 'auto'}">自動</button>
              <button @click="combos[index].targetMode = 'manual'"
                :class="{active: combos[index].targetMode === 'manual'}">手動</button>
            </div>
          </div>
          <div class="stat-item range-setting">
            <span>射程: <input type="text"
                :value="combos[index].rangeMode === 'auto' ? combo.range : combos[index].manualRange"
                :readonly="combos[index].rangeMode === 'auto'" @input="combos[index].manualRange = $event.target.value"
                class="manual-input"></span>
            <div class="mode-toggle">
              <button @click="combos[index].rangeMode = 'auto'"
                :class="{active: combos[index].rangeMode === 'auto'}">自動</button>
              <button @click="combos[index].rangeMode = 'manual'"
                :class="{active: combos[index].rangeMode === 'manual'}">手動</button>
            </div>
          </div>

          <div class="stat-item base-ability-input">
            <span>技能値:</span>
            <select v-model="combos[index].baseAbility.skill">
              <option v-for="opt in dropdownOptions.baseSkillSelect" :value="opt">{{ opt }}</option>
            </select>
            <input type="number" v-model.number="combos[index].baseAbility.value">
          </div>

          <div class="stat-item" :title="combo.atkBreakdown">ATK: {{ combo.totalAtk }}</div>
          <div class="stat-item" :title="combo.costBreakdown">侵蝕値: {{ combo.totalCost }}</div>
        </div>
        <button @click.stop="openEffectSelectModal(index)" class="effect-select-button"><i
            class="fa-solid fa-check-double"></i> 組合せ ({{ (combos[index].effectNames ? combos[index].effectNames.length
          : 0) + (combos[index].itemNames ? combos[index].itemNames.length : 0) }}件選択中): {{ combo.compositionText
          }}</button>
        <div class="combo-details-grid">
          <div class="combo-textarea-wrapper">
            <div class="textarea-header"><label>フレーバーテキスト</label></div>
            <textarea v-model="combos[index].flavor" placeholder="例: 相手を焼き尽くす。"></textarea>
          </div>
          <div class="combo-textarea-wrapper">
            <div class="textarea-header">
              <label>効果解説</label>
              <div class="header-controls">
                <label class="advanced-parsing-switch" title="ONにすると、効果解説内の[LV*3]のような計算式を自動で解決して表示します。">
                  <input type="checkbox" v-model="combos[index].enableAdvancedParsing" class="switch">
                  <span>解説のLvを自動計算</span>
                </label>
                <div class="mode-toggle">
                  <button @click="combos[index].effectDescriptionMode = 'auto'"
                    :class="{active: combos[index].effectDescriptionMode === 'auto'}">自動転記</button>
                  <button @click="switchToManualMode(combos[index], index)"
                    :class="{active: combos[index].effectDescriptionMode === 'manual'}">手動編集</button>
                </div>
              </div>
            </div>
            <textarea v-if="combos[index].effectDescriptionMode === 'manual'"
              v-model="combos[index].manualEffectDescription" placeholder="ここに独自の効果解説を入力"></textarea>
            <textarea v-else readonly :value="combo.autoEffectText"></textarea>
          </div>
        </div>
        <div class="combo-palette-display">
          <div class="copy-container">
            <textarea readonly :value="combo.chatPalette.header"></textarea>
            <button @click="copyToClipboard(combo.chatPalette.header, $event)"><i
                class="fa-solid fa-paste"></i></button>
          </div>
          <div class="copy-container">
            <textarea readonly :value="combo.chatPalette.diceFormula" class="dice-formula-textarea"></textarea>
            <button @click="copyToClipboard(combo.chatPalette.diceFormula, $event)"><i
                class="fa-solid fa-paste"></i></button>
          </div>
        </div>

      </div>
      <button @click="addCombo" class="add-btn"><i class="fa-solid fa-plus"></i> コンボを追加</button>

      <div v-if="isPanelOpen" class="floating-panel" :style="panelStyle" @click.stop>
        <div class="panel-header">
          <h3>{{ editingEffect.name || '新規' }} 詳細設定</h3><button @click="closeEffectPanel" class="close-btn">×</button>
        </div>
        <div class="panel-body">
          <div class="modal-tabs"><button v-for="tab in modalTabs" :key="tab.key"
              :class="{ active: activeModalTab === tab.key }" @click="activeModalTab = tab.key">{{ tab.label }}</button>
          </div>
          <div class="modal-tab-content">
            <div v-show="activeModalTab !== 'crit'" class="panel-grid">
              <div class="input-group"><label>{{ activeModalTabLabel }} 基本値: <span class="input-example">(例: <span
                      class="color-base">+X</span>)</span></label><input type="number"
                  v-model.number="editingEffect.values[activeModalTab].base"></div>
              <div class="input-group" v-if="editingEffectType !== 'item'"><label>{{ activeModalTabLabel }} Lv毎加算: <span
                    class="input-example">(例: <span class="color-per-level">LV×N</span>)</span></label><input
                  type="number" v-model.number="editingEffect.values[activeModalTab].perLevel"></div>
            </div>
            <div v-show="activeModalTab === 'crit'">
              <div class="input-group"><label>C値 基本値:</label><input type="number"
                  v-model.number="editingEffect.values.crit.base"></div>
              <div class="input-group" v-if="editingEffectType !== 'item'"><label>C値 Lv毎減算:</label><input type="number"
                  v-model.number="editingEffect.values.crit.perLevel"></div>
              <div class="input-group"><label>C値 下限:</label><input type="number"
                  v-model.number="editingEffect.values.crit.min"></div>
            </div>
          </div>
        </div>
      </div>

      <div v-if="isEffectSelectModalOpen" class="modal-overlay">
        <div class="modal-content effect-select-modal" @click.stop>
          <div class="modal-header">
            <h3>コンボのエフェクトを選択</h3><button @click.stop="cancelEffectSelection" class="close-btn">×</button>
          </div>
          <div class="modal-body">
            <div class="option-group">
              <strong>エフェクト</strong>
              <label v-for="effect in effects" :key="effect.name + editingComboIndex + 'effect-select'"
                :class="{disabled: isEffectDisabled(effect)}"><input type="checkbox" :value="effect"
                  v-model="tempSelectedEffects" :disabled="isEffectDisabled(effect)"> {{ effect.name }} ({{
                effect.timing }})</label>
            </div>
            <div class="option-group">
              <strong>イージーエフェクト</strong>
              <label v-for="ee in easyEffects" :key="ee.name + editingComboIndex + 'ee-select'"
                :class="{disabled: isEffectDisabled(ee)}"><input type="checkbox" :value="ee"
                  v-model="tempSelectedEffects" :disabled="isEffectDisabled(ee)"> {{ ee.name }} ({{ ee.timing
                }})</label>
            </div>
            <div class="option-group">
              <strong>アイテム</strong>
              <label v-for="item in items" :key="item.name + editingComboIndex + 'item-select'"
                class="item-select-label">
                <input type="checkbox" :value="item" v-model="tempSelectedItems">
                <span>{{ item.name }} ({{ item.type }})</span>
                <button @click.stop="toggleShowInComboName(item)" :class="{active: isShowInComboName(item.name)}"
                  :disabled="!isItemSelected(item.name)" class="show-in-combo-btn"
                  title="クリックでコンボ名への表示／非表示を切替">コンボ</button>
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button @click.stop="cancelEffectSelection" class="cancel-btn">キャンセル</button>
            <button @click.stop="confirmEffectSelection">決定</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <button onclick="topFunction()" id="backToTopBtn" title="トップへ戻る">▲</button>
  <script src="js/common.js"></script>


  <script src="js/dx3_combo_generator.js"></script>
</body>

</html>