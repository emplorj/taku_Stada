<!DOCTYPE html>
<html lang="ja">

<head>
  <meta name="robots" content="noindex">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>シンジュクロウラー 探索者シート | 卓スタダ</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/shinjuku_crawler.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>

<body>
  <!-- 共通ヘッダー読み込み用 -->
  <div id="header-placeholder"></div>
  <canvas id="particleCanvas"></canvas>

  <div class="main-content">
    <header class="main-header crawler-header">
      <div class="crawler-logo-area">
        <p class="catch-copy">わくわくバイトはダイミー！</p>
        <h1>シンジュクロウラー <span class="sub">探索者シート</span></h1>
      </div>
      <div class="header-status">
        <!-- 所持金 (幅広) -->
        <div class="status-box wide">
          <label>所持金 (裏円)</label>
          <input type="number" name="money" value="0" placeholder="0">
        </div>
        <!-- 名声点 -->
        <div class="status-box wide">
          <label>名声点</label>
          <input type="number" name="fame_points" value="0">
        </div>
        <!-- 体力 -->
        <div class="status-box">
          <label>体力</label>
          <input type="number" name="stamina" min="0" max="20" value="1">
        </div>
        <!-- やる気 -->
        <div class="status-box">
          <label>やる気</label>
          <input type="number" name="spirit" min="0" max="20" value="1">
        </div>
      </div>
    </header>

    <form id="shinjuku-sheet">

      <div class="sheet-layout">
        <!-- 左カラム：基本情報、カバンパズル -->
        <div class="left-column">
          <!-- (基本情報とカバンエリアは変更なし) -->
          <div class="section-panel basic-info">
            <div class="input-row"><label>PL名</label><input type="text" name="player_name"></div>
            <div class="input-row"><label>PC名</label><input type="text" name="pc_name"></div>
            <div class="input-row"><label>背景</label><input type="text" name="background"></div>
            <div class="input-row"><label>タグ</label><input type="text" name="tags"></div>
            <div class="input-row"><label>動機</label><input type="text" name="motivation"></div>
            <div class="input-area">
              <label>メモ</label>
              <textarea name="memo" rows="3"></textarea>
            </div>
          </div>

          <div class="section-panel bag-section">
            <!-- (カバンの中身は変更なし) -->
            <div class="panel-header">
              <h3>カバン</h3>
              <div id="penalty-display">ペナルティ: 0</div>
            </div>
            <div class="puzzle-container-wrapper">
              <div id="puzzle-area" class="puzzle-area">
                <div class="penalty-background" id="penalty-background"><span>⚠️ OVERFLOW ⚠️</span></div>
                <div class="grid-background" id="grid-background"></div>
                <div id="item-layer"></div>
                <div class="safe-zone-label">SAFE ZONE (6x6)</div>
              </div>
            </div>
            <div class="puzzle-help">
              <p><i class="fa-solid fa-arrow-pointer"></i> ドラッグで移動 | <i class="fa-solid fa-rotate"></i>
                <b>ダブルクリックで回転</b>
              </p>
            </div>
          </div>
        </div>

        <!-- 右カラム：装備・名声技能・所持品リスト -->
        <div class="right-column">

          <!-- 装備欄 -->
          <div class="section-panel equipment">
            <h3>装備 <span style="font-size:0.8em; font-weight:normal;">(カバンとは別枠)</span></h3>
            <table class="crawler-table">
              <colgroup>
                <col style="width: 5%;"> <!-- 部位 -->
                <col style="width: 22%;"> <!-- 名前 -->
                <col style="width: 10%;"> <!-- Dmg/耐久 -->
                <col style="width: 8%;"> <!-- 価格 -->
                <col style="width: 15%;"> <!-- サイズ -->
                <col style="width: 40%;"> <!-- 備考 -->
              </colgroup>
              <thead>
                <tr>
                  <th>部位</th>
                  <th>名前</th>
                  <th style="font-size:0.8rem;">ダメ/耐久</th>
                  <th>価格</th>
                  <th>サイズ（メモ用）</th>
                  <th>備考</th>
                </tr>
              </thead>
              <tbody>
                <!-- 右手 -->
                <tr>
                  <td class="fixed-label">右手</td>
                  <td><input type="text" name="equip_r_name"></td>
                  <td><input type="text" name="equip_r_stat" placeholder="ダメージ"></td>
                  <td><input type="number" name="equip_r_price" placeholder="0"></td>
                  <td>
                    <div class="size-input-group">
                      <input type="number" name="equip_r_w" value="1" min="1">
                      <span>×</span>
                      <input type="number" name="equip_r_h" value="1" min="1">
                    </div>
                  </td>
                  <td><textarea name="equip_r_note" rows="1"></textarea></td>
                </tr>
                <!-- 左手 -->
                <tr>
                  <td class="fixed-label">左手</td>
                  <td><input type="text" name="equip_l_name"></td>
                  <td><input type="text" name="equip_l_stat" placeholder="ダメージ"></td>
                  <td><input type="number" name="equip_l_price" placeholder="0"></td>
                  <td>
                    <div class="size-input-group">
                      <input type="number" name="equip_l_w" value="1" min="1">
                      <span>×</span>
                      <input type="number" name="equip_l_h" value="1" min="1">
                    </div>
                  </td>
                  <td><textarea name="equip_l_note" rows="1"></textarea></td>
                </tr>
                <!-- 胴 -->
                <tr>
                  <td class="fixed-label">胴</td>
                  <td><input type="text" name="equip_b_name"></td>
                  <td><input type="text" name="equip_b_stat" placeholder="耐久"></td>
                  <td><input type="number" name="equip_b_price" placeholder="0"></td>
                  <td>
                    <div class="size-input-group">
                      <input type="number" name="equip_b_w" value="1" min="1">
                      <span>×</span>
                      <input type="number" name="equip_b_h" value="1" min="1">
                    </div>
                  </td>
                  <td><textarea name="equip_b_note" rows="1"></textarea></td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 所持品リスト -->
          <div class="section-panel item-section">
            <div class="panel-header">
              <h3>所持品リスト</h3>
              <button type="button" id="btn-sync-puzzle" class="sync-btn"><i class="fa-solid fa-arrows-rotate"></i>
                カバンに反映</button>
            </div>
            <p class="small-help">サイズ（横 × 縦）を入力して「反映」でアイテムが出現します。</p>

            <table class="crawler-table item-table" id="item-list">
              <colgroup>
                <col style="width: 37%;"> <!-- 名前 -->
                <col style="width: 8%;"> <!-- 価格 -->
                <col style="width: 15%;"> <!-- サイズ -->
                <col style="width: 10%;"> <!-- 残回数 -->
                <col style="width: 25%;"> <!-- 備考 -->
                <col style="width: 5%;"> <!-- 削除 -->
              </colgroup>
              <thead>
                <tr>
                  <th>名前</th>
                  <th>価格</th>
                  <th>サイズ</th>
                  <th style="font-size:0.8rem;">残回数</th>
                  <th>効果・備考</th>
                  <th><i class="fa-solid fa-trash"></i></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <button type="button" id="add-item-row" class="add-row-btn"><i class="fa-solid fa-plus"></i> 行を追加</button>
          </div>
        </div>
      </div>
      <!-- アフタープレイ・履歴エリア (折りたたみ) -->
      <details class="section-panel bottom-details">
        <summary>
          <h3><i class="fa-solid fa-book"></i> 名声技能・履歴データ <span
              style="font-size:0.8rem; font-weight:normal;">(クリックで開閉)</span></h3>
        </summary>

        <!-- ★修正: 左右2カラムにするためのクラス "two-column-layout" を追加 -->
        <div class="bottom-content-wrapper two-column-layout">

          <!-- 左側: 名声技能 -->
          <div class="bottom-col-left">
            <div class="fame-skills-section">
              <div
                style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #444; margin-bottom:5px;">
                <h4 style="color:#d500f9; border:none; margin:0;">名声技能</h4>
                <div style="font-size:0.8rem; color:#bbb;">
                  取得数: <span id="fame-count">0</span> / <span id="fame-max">0</span>
                </div>
              </div>
              <div class="table-scroll">
                <table class="crawler-table" id="fame-skills-table">
                  <colgroup>
                    <!-- ★修正: 削除列を消して幅を調整 -->
                    <col style="width: 35%;"> <!-- 名前 -->
                    <col style="width: 65%;"> <!-- 効果 -->
                  </colgroup>
                  <thead>
                    <tr>
                      <th>技能名</th>
                      <th>効果</th>
                      <!-- ★削除: <th><i class="fa-solid fa-trash"></i></th> -->
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <!-- 手動追加ボタンは既に削除済み -->
              </div>
            </div>
          </div>

          <!-- 右側: 履歴セクション -->
          <div class="bottom-col-right">
            <div class="history-section">
              <div class="panel-header">
                <h4 style="margin:0; color:#d500f9;">収支・セッション履歴</h4>
                <div class="calc-info">
                  合計報酬: <span id="total-rewards">0</span> 裏円 /
                  名声: <span id="total-fame">0</span>
                </div>
              </div>

              <!-- セッション履歴 -->
              <h5 style="color:#bbb; margin:10px 0 5px;">セッション履歴<small>（プラスで収入、マイナスで支出）</small></h5>
              <div class="table-scroll">
                <table class="crawler-table history-table" id="session-history">
                  <!-- ★修正: 列幅を調整 (日付・金額を狭く) -->
                  <colgroup>
                    <col style="width: 20%;"> <!-- 日付: 狭く -->
                    <col style="width: 25%;"> <!-- タイトル: 広く -->
                    <col style="width: 10%;"> <!-- 裏円: 狭く -->
                    <col style="width: 10%;"> <!-- 名声: 狭く -->
                    <col style="width: 30%;"> <!-- 備考 -->
                    <col style="width: 5%;"> <!-- 削除 -->
                  </colgroup>
                  <thead>
                    <tr>
                      <th>日付</th>
                      <th>タイトル</th>
                      <th>裏円</th>
                      <th>名声</th>
                      <th>GM/参加者/備考</th>
                      <th><i class="fa-solid fa-trash"></i></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <button type="button" id="add-session-row" class="add-row-btn small">+ 行を追加</button>
              </div>

              <!-- 購入/支出履歴 -->
              <h5 style="color:#bbb; margin:15px 0 5px;">購入・支出履歴</h5>
              <div class="table-scroll">
                <table class="crawler-table history-table" id="purchase-history">
                  <!-- ★修正: 列幅を調整 -->
                  <colgroup>
                    <col style="width: 45%;"> <!-- 項目名 -->
                    <col style="width: 10%;"> <!-- 金額: 狭く -->
                    <col style="width: 40%;"> <!-- 備考: 広く -->
                    <col style="width: 5%;"> <!-- 削除 -->
                  </colgroup>
                  <thead>
                    <tr>
                      <th>項目名</th>
                      <th>金額</th>
                      <th>備考</th>
                      <th><i class="fa-solid fa-trash"></i></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <button type="button" id="add-purchase-row" class="add-row-btn small">+ 行を追加</button>
              </div>
            </div>
          </div>
        </div>
      </details>

      <!-- コントロール -->
      <div class="crawler-controls-area">
        <!-- ID入力エリア -->
        <div class="save-key-group">
          <label>キャラクターID</label>
          <input type="text" id="character-id" placeholder="英数字推奨"
            style="background:#222; color:#fff; border:1px solid #555; padding:5px;">
          <p class="small-help">※IDが被ると上書きされます。ユニークなIDにしてください。</p>
        </div>

        <div class="crawler-controls">
          <input type="hidden" name="puzzle_positions" id="puzzle_positions">

          <!-- 公開設定チェックボックス -->
          <div class="privacy-check">
            <label>
              <input type="checkbox" id="is-private">
              <span>一覧リストに表示しない</span>
            </label>
          </div>

          <button type="button" id="btn-save-server" class="crawler-btn save-server">
            <i class="fa-solid fa-cloud-arrow-up"></i> サーバーに保存
          </button>

          <button type="button" id="btn-load-server" class="crawler-btn load-server">
            <i class="fa-solid fa-cloud-arrow-down"></i> IDから読込
          </button>


          <button type="button" id="btn-share" class="crawler-btn share">
            <i class="fa-solid fa-share-nodes"></i> 共有URL
          </button>
          <button type="button" id="btn-copy-ccfolia" class="crawler-btn ccfolia" style="background-color:#2c3e50;">
            <i class="fa-solid fa-clipboard"></i> ココフォリア駒出力
          </button>
          <button type="button" id="btn-reset" class="crawler-btn reset">リセット</button>
        </div>
      </div>

      <!-- キャラクター一覧セクション -->
      <div class="character-list-section">
        <h2 class="start-title system-color-border"><i class="fa-solid fa-list"></i> みんなのキャラクター</h2>
        <div class="list-controls">
          <button type="button" id="btn-refresh-list" class="crawler-btn load"><i class="fa-solid fa-rotate"></i>
            更新</button>
        </div>
        <div class="list-container">
          <table class="list-table">
            <thead>
              <tr>
                <th>PC名</th>
                <th>PL名</th>
                <th>更新日時</th>
                <th>参照</th>
              </tr>
            </thead>
            <tbody id="character-list-body">
              <tr>
                <td colspan="4" style="text-align:center;">読み込み中...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </form>

    <footer>
      <p>© 2025 卓スタダ.</p>
    </footer>
  </div>

  <button onclick="topFunction()" id="backToTopBtn">▲</button>
  <script src="js/common.js"></script>
  <!-- パズル処理用スクリプト -->
  <script src="js/bag_puzzle.js"></script>

  <script>
    // ★GASのウェブアプリURL
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxMR7f_pOi14SsAuKvu7YxKVBQZ69dn-TeQpMBxyYzo_pwZmICNZ06cSb8BKQYCM0GuGg/exec";

    // フォーム要素
    const form = document.getElementById('shinjuku-sheet');
    const idInput = document.getElementById('character-id');

    // 各テーブルのtbody取得
    const sessionBody = document.querySelector('#session-history tbody');
    const purchaseBody = document.querySelector('#purchase-history tbody');
    const fameBody = document.querySelector('#fame-skills-table tbody'); // ここが重要

    // 計算用要素
    const moneyInput = document.querySelector('input[name="money"]');
    const fameInput = document.querySelector('input[name="fame_points"]');
    const totalRewardsSpan = document.getElementById('total-rewards');
    const totalFameSpan = document.getElementById('total-fame');
    const fameCountSpan = document.getElementById('fame-count');
    const fameMaxSpan = document.getElementById('fame-max');

    // テキストエリア自動高さ調整
    function autoResizeTextarea(el) {
      if (!el) return;
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight) + 'px';
    }

    function setupTextareaAutoResize(scope) {
      const targets = scope.querySelectorAll ? scope.querySelectorAll('textarea') : [scope];
      targets.forEach(ta => {
        ta.addEventListener('input', () => autoResizeTextarea(ta));
        setTimeout(() => autoResizeTextarea(ta), 0);
      });
    }

    // --- 行操作関数 ---

    function addSessionRow(data = {}) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
            <td><input type="date" name="sess_date" value="${data.date || ''}"></td>
            <td><textarea name="sess_title" rows="1">${data.title || ''}</textarea></td>
            <td><input type="number" name="sess_money" value="${data.money || 0}" class="calc-trigger"></td>
            <td><input type="number" name="sess_fame" value="${data.fame || 0}" class="calc-trigger"></td>
            <td><textarea name="sess_memo" rows="1">${data.memo || ''}</textarea></td>
            <td class="delete-cell"><button type="button" class="delete-row-btn"><i class="fa-solid fa-trash"></i></button></td>
        `;
      tr.querySelector('.delete-row-btn').addEventListener('click', () => { tr.remove(); calculateTotal(); });
      tr.querySelectorAll('.calc-trigger').forEach(el => el.addEventListener('input', calculateTotal));
      sessionBody.appendChild(tr);
      setupTextareaAutoResize(tr);
    }

    function addPurchaseRow(data = {}) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
            <td><textarea name="pur_item" rows="1">${data.item || ''}</textarea></td>
            <td><input type="number" name="pur_cost" value="${data.cost || 0}" class="calc-trigger"></td>
            <td><textarea name="pur_memo" rows="1">${data.memo || ''}</textarea></td>
            <td class="delete-cell"><button type="button" class="delete-row-btn"><i class="fa-solid fa-trash"></i></button></td>
        `;
      tr.querySelector('.delete-row-btn').addEventListener('click', () => { tr.remove(); calculateTotal(); });
      tr.querySelectorAll('.calc-trigger').forEach(el => el.addEventListener('input', calculateTotal));
      purchaseBody.appendChild(tr);
      setupTextareaAutoResize(tr);
    }

    // 名声技能 行追加 (自動調整用)
    function addFameRow(data = {}) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
            <td><input type="text" name="fame_name" value="${data.name || ''}" placeholder="技能名"></td>
            <td><textarea name="fame_effect" rows="1" placeholder="効果">${data.effect || ''}</textarea></td>
        `;
      fameBody.appendChild(tr);
      setupTextareaAutoResize(tr);
    }

    // イベントリスナー
    document.getElementById('add-session-row').addEventListener('click', () => addSessionRow());
    document.getElementById('add-purchase-row').addEventListener('click', () => addPurchaseRow());

    // --- 自動計算 (Core Logic) ---
    function calculateTotal() {
      let totalMoney = 0;
      let totalFame = 0;

      // 履歴から集計
      sessionBody.querySelectorAll('tr').forEach(tr => {
        const m = parseInt(tr.querySelector('input[name="sess_money"]').value) || 0;
        const f = parseInt(tr.querySelector('input[name="sess_fame"]').value) || 0;
        totalMoney += m;
        totalFame += f;
      });

      purchaseBody.querySelectorAll('tr').forEach(tr => {
        const c = parseInt(tr.querySelector('input[name="pur_cost"]').value) || 0;
        totalMoney += c;
      });

      // ヘッダー反映
      moneyInput.value = totalMoney;
      fameInput.value = totalFame;
      if (totalRewardsSpan) totalRewardsSpan.textContent = totalMoney;
      if (totalFameSpan) totalFameSpan.textContent = totalFame;

      // ★名声技能枠の計算
      let maxSkills = 0;
      if (totalFame >= 1500) {
        maxSkills = 4 + Math.floor((totalFame - 1500) / 500);
      } else if (totalFame >= 1000) {
        maxSkills = 3;
      } else if (totalFame >= 700) {
        maxSkills = 2;
      } else if (totalFame >= 200) {
        maxSkills = 1;
      } else {
        maxSkills = 0;
      }

      if (fameMaxSpan) fameMaxSpan.textContent = maxSkills;

      // 枠の増減処理
      const currentRows = Array.from(fameBody.querySelectorAll('tr'));
      const currentCount = currentRows.length;

      if (fameCountSpan) fameCountSpan.textContent = currentCount;

      if (currentCount < maxSkills) {
        // 足りない分を追加
        const diff = maxSkills - currentCount;
        for (let i = 0; i < diff; i++) addFameRow();
      } else if (currentCount > maxSkills) {
        // 多い分を削除（ただし空行のみ）
        // 後ろからチェック
        for (let i = currentCount - 1; i >= maxSkills; i--) {
          const row = currentRows[i];
          const name = row.querySelector('input[name="fame_name"]').value;
          const effect = row.querySelector('textarea[name="fame_effect"]').value;
          if (!name && !effect) {
            row.remove();
          }
        }
      }

      // 更新後の数を再表示
      if (fameCountSpan) {
        const finalCount = fameBody.querySelectorAll('tr').length;
        fameCountSpan.textContent = finalCount;
        fameCountSpan.style.color = (finalCount > maxSkills) ? '#ff5555' : '#fff';
      }
    }

    // --- 初期化 ---
    window.addEventListener('DOMContentLoaded', () => {
      const savedPlName = localStorage.getItem('shinjuku_pl_name');
      if (savedPlName) {
        const plInput = document.querySelector('input[name="player_name"]');
        if (plInput) plInput.value = savedPlName;
      }

      // URLパラメータ処理
      const urlParams = new URLSearchParams(window.location.search);
      const queryId = urlParams.get('id');
      if (queryId) {
        idInput.value = queryId;
        loadFromServer(queryId, true);
      }

      if (typeof fetchCharacterList === 'function') fetchCharacterList();

      // 初期行追加
      if (sessionBody.rows.length === 0) addSessionRow();
      if (purchaseBody.rows.length === 0) addPurchaseRow();

      // 名声技能は初期0行でもOK（計算で増えるため）。
      // ただし、名声0でも手動で書きたい場合があるなら1行入れても良いが、
      // ルール的には「名声200で1つ」なので、初期は0行が正しい。
      // もし強制的に1行欲しいなら下記を有効化
      // if (fameBody.rows.length === 0) addFameRow();

      setupTextareaAutoResize(document.body);

      // ★重要: 初回計算を実行して枠を調整
      calculateTotal();
    });

    // --- データ取得/反映 ---
    function getFormDataAsJson() {
      const formData = new FormData(form);
      const data = {};
      formData.forEach((value, key) => {
        if (!key.startsWith('sess_') && !key.startsWith('pur_') && !key.startsWith('fame_')) {
          data[key] = value;
        }
      });
      data['__item_rows'] = document.querySelector('#item-list tbody').rows.length;

      data['session_history'] = [];
      sessionBody.querySelectorAll('tr').forEach(tr => {
        data['session_history'].push({
          date: tr.querySelector('input[name="sess_date"]').value,
          title: tr.querySelector('textarea[name="sess_title"]').value,
          money: tr.querySelector('input[name="sess_money"]').value,
          fame: tr.querySelector('input[name="sess_fame"]').value,
          memo: tr.querySelector('textarea[name="sess_memo"]').value
        });
      });

      data['purchase_history'] = [];
      purchaseBody.querySelectorAll('tr').forEach(tr => {
        data['purchase_history'].push({
          item: tr.querySelector('textarea[name="pur_item"]').value,
          cost: tr.querySelector('input[name="pur_cost"]').value,
          memo: tr.querySelector('textarea[name="pur_memo"]').value
        });
      });

      data['fame_skills_list'] = [];
      fameBody.querySelectorAll('tr').forEach(tr => {
        data['fame_skills_list'].push({
          name: tr.querySelector('input[name="fame_name"]').value,
          effect: tr.querySelector('textarea[name="fame_effect"]').value
        });
      });
      return data;
    }

    function applyDataToSheet(data) {
      if (data['__item_rows']) {
        const current = document.querySelector('#item-list tbody').rows.length;
        const needed = parseInt(data['__item_rows']);
        for (let i = current; i < needed; i++) document.getElementById('add-item-row').click();
      }

      // 履歴復元
      sessionBody.innerHTML = '';
      if (data['session_history']) data['session_history'].forEach(row => addSessionRow(row));
      else addSessionRow();

      purchaseBody.innerHTML = '';
      if (data['purchase_history']) data['purchase_history'].forEach(row => addPurchaseRow(row));
      else addPurchaseRow();

      // 名声技能復元
      fameBody.innerHTML = '';
      if (data['fame_skills_list']) {
        data['fame_skills_list'].forEach(row => addFameRow(row));
      } else if (data['fame_skills']) {
        addFameRow({ name: '旧データ', effect: data['fame_skills'] });
      }
      // ★ポイント: 復元直後は枠数が合わない可能性があるが、直後のcalculateTotalで調整される

      Object.keys(data).forEach(key => {
        if (!['__item_rows', 'puzzle_positions', 'session_history', 'purchase_history', 'fame_skills_list'].includes(key)) {
          const el = form.elements[key];
          if (el) el.value = data[key];
        }
      });

      if (window.restorePuzzle && data['puzzle_positions']) window.restorePuzzle(data['puzzle_positions']);

      // ★計算と枠調整
      calculateTotal();
      setTimeout(() => setupTextareaAutoResize(document.body), 50);
    }

    // --- サーバー通信 ---
    document.getElementById('btn-save-server').addEventListener('click', async () => {
      const charId = idInput.value.trim();
      const isPrivate = document.getElementById('is-private').checked;
      if (!charId) { alert('IDを入力してください'); return; }

      localStorage.setItem('shinjuku_pl_name', document.querySelector('input[name="player_name"]').value);

      const btn = document.getElementById('btn-save-server');
      btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>...';

      try {
        await fetch(GAS_API_URL, {
          method: 'POST', mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ tool: "shinjuku", action: "save", id: charId, data: getFormDataAsJson(), isPrivate })
        });
        alert('保存しました');
        setTimeout(fetchCharacterList, 2000);
      } catch (e) { alert('保存失敗: ' + e); }
      finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> サーバーに保存'; }
    });

    async function loadFromServer(charId, isAuto) {
      // (省略: 既存のload処理と同じ)
      // ここは変更なしでOKですが、必要なら全文記述します
      if (!charId) return;
      const btn = document.getElementById('btn-load-server');
      let orgText = "";
      if (!isAuto) { orgText = btn.innerHTML; btn.innerHTML = '...'; btn.disabled = true; }
      try {
        const res = await fetch(`${GAS_API_URL}?tool=shinjuku&action=load&id=${encodeURIComponent(charId)}`);
        const json = await res.json();
        if (json.status === 'success') {
          if (isAuto || confirm('読み込みますか？')) applyDataToSheet(json.data);
        } else {
          if (!isAuto) alert(json.message);
        }
      } catch (e) { if (!isAuto) alert(e); }
      finally { if (!isAuto) { btn.innerHTML = orgText; btn.disabled = false; } }
    }

    document.getElementById('btn-load-server').addEventListener('click', () => {
      const id = idInput.value.trim();
      if (!id) { alert('IDを入力してください'); return; }
      loadFromServer(id, false);
    });

    document.getElementById('btn-share').addEventListener('click', () => {
      const id = idInput.value.trim();
      if (!id) return alert('IDを入力してください');
      const url = `${location.protocol}//${location.host}${location.pathname}?id=${encodeURIComponent(id)}`;
      navigator.clipboard.writeText(url).then(() => alert('コピーしました: ' + url));
    });

    document.getElementById('btn-reset').addEventListener('click', () => {
      if (!confirm('リセットしますか？')) return;
      form.reset();
      if (window.restorePuzzle) window.restorePuzzle('[]');
      sessionBody.innerHTML = ''; addSessionRow();
      purchaseBody.innerHTML = ''; addPurchaseRow();
      fameBody.innerHTML = ''; // 名声はクリア
      calculateTotal();
    });

    // 一覧取得等は省略（既存のまま）
  </script>
</body>

</html>