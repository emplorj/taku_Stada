<!DOCTYPE html>
<html lang="ja">

<head>
  <meta name="robots" content="noindex">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>シンジュクロウラー 探索者シート | 卓スタダ</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/shinjuku_crawler.css">
  <link rel="stylesheet" href="css/loading_overlay.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>

<body>
  <!-- ローディングオーバーレイ -->
  <div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <div class="loading-text">読み込み中...</div>
    </div>
  </div>

  <!-- 共通ヘッダー読み込み用 -->
  <div id="header-placeholder"></div>
  <canvas id="particleCanvas"></canvas>

  <div class="main-content">
    <header class="main-header crawler-header">
      <div class="crawler-logo-area">
        <p class="catch-copy">わくわくバイトはダイミー！</p>
        <h1>シンジュクロウラー <span class="sub">探索者シート</span></h1>
      </div>
      <div class="header-status">
        <!-- 所持金 (幅広) -->
        <div class="status-box wide">
          <label>所持金 (裏円)</label>
          <input type="number" name="money" value="0" placeholder="0" readonly tabindex="-1">
        </div>
        <!-- 名声点 -->
        <div class="status-box wide">
          <label>名声点</label>
          <input type="number" name="fame_points" value="0" readonly tabindex="-1">
        </div>
        <!-- 体力 -->
        <div class="status-box">
          <label>体力</label>
          <input type="number" name="stamina" min="0" max="20" value="1">
        </div>
        <!-- やる気 -->
        <div class="status-box">
          <label>やる気</label>
          <input type="number" name="spirit" min="0" max="20" value="1">
        </div>
      </div>
    </header>

    <form id="shinjuku-sheet">

      <div class="sheet-layout">
        <!-- 左カラム：基本情報、カバンパズル -->
        <div class="left-column">

          <div class="section-panel basic-info">
            <div class="input-row"><label>PL名</label><input type="text" name="player_name"></div>
            <div class="input-row"><label>PC名</label><input type="text" name="pc_name"></div>
            <div class="input-row"><label>フリガナ</label><input type="text" name="pc_kana"></div>
            <div class="input-row-double">
              <div class="input-row"><label>年齢</label><input type="text" name="age"></div>
              <div class="input-row"><label>性別</label><input type="text" name="gender"></div>
            </div>
            <div class="input-row"><label>背景</label><input type="text" name="background"></div>
            <div class="input-row"><label>タグ</label><input type="text" name="tags"></div>
            <div class="input-row"><label>動機</label><input type="text" name="motivation"></div>
            <div class="input-area">
              <label>メモ</label>
              <textarea name="memo" rows="3"></textarea>
            </div>
          </div>

          <div class="section-panel bag-section">
            <div class="panel-header">
              <h3>カバン</h3>
              <div id="penalty-display">ペナルティ: 0</div>
            </div>
            <div class="puzzle-container-wrapper">
              <div id="puzzle-area" class="puzzle-area">
                <div class="penalty-background" id="penalty-background"><span>⚠️ OVERFLOW ⚠️</span></div>
                <div class="grid-background" id="grid-background"></div>
                <div id="item-layer"></div>
                <div class="safe-zone-label">SAFE ZONE (6x6)</div>
              </div>
            </div>
            <div class="puzzle-help">
              <p><i class="fa-solid fa-arrow-pointer"></i> ドラッグで移動 | <i class="fa-solid fa-rotate"></i>
                <b>ダブルクリックで回転</b>
              </p>
            </div>
          </div>
        </div>

        <!-- 右カラム：装備・所持品リスト -->
        <div class="right-column">

          <!-- 装備欄 -->
          <div class="section-panel equipment">
            <h3>装備 <span style="font-size:0.8em; font-weight:normal;">(カバンとは別枠)</span></h3>
            <div class="table-scroll">
              <table class="crawler-table">
                <colgroup>
                  <!-- 左側合計: 35% -->
                  <col style="width: 6%;"> <!-- 部位 -->
                  <col style="width: 18%;"> <!-- 名前: 20% -> 18% -->
                  <col style="width: 11%;"> <!-- Dmg/耐久 -->

                  <!-- 右側共通: 65% -->
                  <col style="width: 8%;"> <!-- 価格 -->
                  <col style="width: 7%;"> <!-- 無料: 5% -> 7% -->
                  <col style="width: 15%;"> <!-- サイズ -->
                  <col style="width: 35%;"> <!-- 備考 -->
                </colgroup>
                <thead>
                  <tr>
                    <th>部位</th>
                    <th>名前</th>
                    <th style="font-size:0.8rem;">ダメ/耐久</th>
                    <th>価格</th>
                    <th style="font-size:0.7rem;">無料</th>
                    <th>サイズ（メモ用）</th>
                    <th>備考</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- 右手 -->
                  <tr>
                    <td class="fixed-label">右手</td>
                    <td><input type="text" name="equip_r_name"></td>
                    <td><input type="text" name="equip_r_stat" placeholder="ダメージ"></td>
                    <td><input type="number" name="equip_r_price" placeholder="0" class="calc-trigger"></td>
                    <td style="text-align:center;"><input type="checkbox" name="equip_r_free" class="calc-trigger"></td>
                    <td>
                      <div class="size-input-group">
                        <input type="number" name="equip_r_w" value="1" min="1">
                        <span>×</span>
                        <input type="number" name="equip_r_h" value="1" min="1">
                      </div>
                    </td>
                    <td><textarea name="equip_r_note" rows="1"></textarea></td>
                  </tr>
                  <!-- 左手 -->
                  <tr>
                    <td class="fixed-label">左手</td>
                    <td><input type="text" name="equip_l_name"></td>
                    <td><input type="text" name="equip_l_stat" placeholder="ダメージ"></td>
                    <td><input type="number" name="equip_l_price" placeholder="0" class="calc-trigger"></td>
                    <td style="text-align:center;"><input type="checkbox" name="equip_l_free" class="calc-trigger"></td>
                    <td>
                      <div class="size-input-group">
                        <input type="number" name="equip_l_w" value="1" min="1">
                        <span>×</span>
                        <input type="number" name="equip_l_h" value="1" min="1">
                      </div>
                    </td>
                    <td><textarea name="equip_l_note" rows="1"></textarea></td>
                  </tr>
                  <!-- 胴 -->
                  <tr>
                    <td class="fixed-label">胴</td>
                    <td><input type="text" name="equip_b_name"></td>
                    <td><input type="text" name="equip_b_stat" placeholder="耐久"></td>
                    <td><input type="number" name="equip_b_price" placeholder="0" class="calc-trigger"></td>
                    <td style="text-align:center;"><input type="checkbox" name="equip_b_free" class="calc-trigger"></td>
                    <td>
                      <div class="size-input-group">
                        <input type="number" name="equip_b_w" value="1" min="1">
                        <span>×</span>
                        <input type="number" name="equip_b_h" value="1" min="1">
                      </div>
                    </td>
                    <td><textarea name="equip_b_note" rows="1"></textarea></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- 所持品リスト -->
          <div class="section-panel item-section">
            <div class="panel-header">
              <h3>所持品リスト</h3>
              <button type="button" id="btn-sync-puzzle" class="sync-btn"><i class="fa-solid fa-arrows-rotate"></i>
                カバンに反映</button>
            </div>
            <p class="small-help">サイズを入力して「反映」でアイテムが出現します。</p>

            <div class="table-scroll">
              <table class="crawler-table item-table" id="item-list">
                <colgroup>
                  <!-- 左側合計: 35% -->
                  <col style="width: 35%;"> <!-- 名前: 37% -> 35% -->

                  <!-- 右側共通: 65% -->
                  <col style="width: 8%;"> <!-- 価格 -->
                  <col style="width: 7%;"> <!-- 無料: 5% -> 7% -->
                  <col style="width: 15%;"> <!-- サイズ -->
                  <col style="width: 8%;"> <!-- 残回数 -->
                  <col style="width: 22%;"> <!-- 備考 -->
                  <col style="width: 5%;"> <!-- 削除 -->
                </colgroup>
                <thead>
                  <tr>
                    <th>名前</th>
                    <th>価格</th>
                    <th style="font-size:0.7rem;">無料</th>
                    <th>サイズ</th>
                    <th style="font-size:0.8rem;">残回数</th>
                    <th>効果・備考</th>
                    <th><i class="fa-solid fa-trash"></i></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <button type="button" id="add-item-row" class="add-row-btn"><i class="fa-solid fa-plus"></i> 行を追加</button>
          </div>
        </div>
      </div> <!-- /sheet-layout -->

      <!-- アフタープレイ・履歴エリア (折りたたみ) -->
      <details class="section-panel bottom-details">
        <summary>
          <h3><i class="fa-solid fa-book"></i> 名声技能・履歴データ <span
              style="font-size:0.8rem; font-weight:normal;">(クリックで開閉)</span></h3>
        </summary>

        <div class="bottom-content-wrapper two-column-layout">

          <!-- 左側: 名声技能 -->
          <div class="bottom-col-left">
            <div class="fame-skills-section">
              <div
                style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #444; margin-bottom:5px;">
                <h4 style="color:#d500f9; border:none; margin:0;">名声技能</h4>
                <div style="font-size:0.8rem; color:#bbb;">
                  取得数: <span id="fame-count">0</span> / <span id="fame-max">0</span>
                </div>
              </div>
              <div class="table-scroll">
                <table class="crawler-table" id="fame-skills-table">
                  <colgroup>
                    <col style="width: 35%;"> <!-- 名前 -->
                    <col style="width: 65%;"> <!-- 効果 -->
                  </colgroup>
                  <thead>
                    <tr>
                      <th>技能名</th>
                      <th>効果</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <!-- 手動追加ボタンは自動管理のため削除 -->
              </div>
            </div>
          </div>

          <!-- 右側: 履歴セクション -->
          <div class="bottom-col-right">
            <div class="history-section">
              <div class="panel-header">
                <h4 style="margin:0; color:#d500f9;">収支・セッション履歴</h4>

                <!-- 初期値入力エリア -->
                <div class="calc-info-inputs">
                  <div class="init-group">
                    <label>初期裏円</label>
                    <input type="number" name="init_money" value="0" placeholder="0">
                  </div>
                  <div class="init-group">
                    <label>初期名声</label>
                    <input type="number" name="init_fame" value="0" placeholder="0">
                  </div>
                </div>
              </div>

              <!-- セッション履歴 -->
              <h5 style="color:#bbb; margin:10px 0 5px;">セッション履歴<small>（プラスで収入、マイナスで支出）</small></h5>
              <div class="table-scroll">
                <table class="crawler-table history-table" id="session-history">
                  <colgroup>
                    <col style="width: 20%;"> <!-- 日付 -->
                    <col style="width: 25%;"> <!-- タイトル -->
                    <col style="width: 10%;"> <!-- 裏円 -->
                    <col style="width: 10%;"> <!-- 名声 -->
                    <col style="width: 30%;"> <!-- 備考 -->
                    <col style="width: 5%;"> <!-- 削除 -->
                  </colgroup>
                  <thead>
                    <tr>
                      <th>日付</th>
                      <th>タイトル</th>
                      <th>裏円</th>
                      <th>名声</th>
                      <th>GM/参加者/備考</th>
                      <th><i class="fa-solid fa-trash"></i></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <button type="button" id="add-session-row" class="add-row-btn small">+ 行を追加</button>
              </div>

              <!-- 購入/支出履歴 -->
              <h5 style="color:#bbb; margin:15px 0 5px;">購入・支出履歴</h5>
              <div class="table-scroll">
                <table class="crawler-table history-table" id="purchase-history">
                  <colgroup>
                    <col style="width: 45%;"> <!-- 項目名 -->
                    <col style="width: 10%;"> <!-- 金額 -->
                    <col style="width: 40%;"> <!-- 備考 -->
                    <col style="width: 5%;"> <!-- 削除 -->
                  </colgroup>
                  <thead>
                    <tr>
                      <th>項目名</th>
                      <th>金額</th>
                      <th>備考</th>
                      <th><i class="fa-solid fa-trash"></i></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <button type="button" id="add-purchase-row" class="add-row-btn small">+ 行を追加</button>
              </div>
            </div>
          </div>
        </div>
      </details>

      <!-- コントロール -->
      <div class="crawler-controls-area">
        <!-- ID入力エリア -->
        <div class="save-key-group">
          <label>キャラクターID</label>
          <input type="text" id="character-id" placeholder="英数字推奨"
            style="background:#222; color:#fff; border:1px solid #555; padding:5px;">
          <p class="small-help">※IDが被ると上書きされます。ユニークなIDにしてください。</p>
        </div>

        <div class="crawler-controls">
          <input type="hidden" name="puzzle_positions" id="puzzle_positions">

          <!-- 公開設定チェックボックス -->
          <div class="privacy-check">
            <label>
              <input type="checkbox" id="is-private">
              <span>一覧リストに表示しない</span>
            </label>
          </div>

          <button type="button" id="btn-save-server" class="crawler-btn save-server">
            <i class="fa-solid fa-cloud-arrow-up"></i> 保存
          </button>




          <button type="button" id="btn-share" class="crawler-btn share">
            <i class="fa-solid fa-share-nodes"></i> 共有URL
          </button>
          <button type="button" id="btn-copy-ccfolia" class="crawler-btn ccfolia" style="background-color:#2c3e50;">
            <i class="fa-solid fa-clipboard"></i> ココフォリア駒出力
          </button>
          <button type="button" id="btn-reset" class="crawler-btn reset">リセット</button>
        </div>
      </div>

      <!-- キャラクター一覧セクション -->
      <details class="character-list-section">
        <summary>
          <h2 class="start-title system-color-border">みんなのキャラクター</h2>
        </summary>
        <div class="list-controls">
          <button type="button" id="btn-refresh-list" class="crawler-btn load"><i class="fa-solid fa-rotate"></i>
            更新</button>
        </div>
        <div class="list-container">
          <table class="list-table">
            <thead>
              <tr>
                <th>PC名</th>
                <th>PL名</th>
                <th>更新日時</th>
                <th>参照</th>
              </tr>
            </thead>
            <tbody id="character-list-body">
              <tr>
                <td colspan="4" style="text-align:center;">読み込み中...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </details>

    </form>

    <footer>
      <p>© 2025 卓スタダ.</p>
    </footer>
  </div>

  <button onclick="topFunction()" id="backToTopBtn">▲</button>
  <script src="js/common.js"></script>
  <!-- パズル処理用スクリプト -->
  <script src="js/bag_puzzle.js"></script>

  <script>
    // ★GASのウェブアプリURL
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxMR7f_pOi14SsAuKvu7YxKVBQZ69dn-TeQpMBxyYzo_pwZmICNZ06cSb8BKQYCM0GuGg/exec";

    // 変数を宣言（中身は初期化時に取得）
    let form, idInput;
    let sessionBody, purchaseBody, fameBody;
    let moneyInput, fameInput, totalRewardsSpan, totalFameSpan, fameCountSpan, fameMaxSpan;
    let initMoneyInput, initFameInput;

    // --- テキストエリア自動高さ調整 ---
    function autoResizeTextarea(el) {
      if (!el) return;
      // 要素が見えていない(高さ0)の場合は処理しない(開いたときにやる)
      if (el.offsetParent === null) return;

      el.style.height = 'auto';
      const newHeight = el.scrollHeight;
      if (newHeight > 0) {
        el.style.height = newHeight + 'px';
      }
    }

    function setupTextareaAutoResize(scope) {
      if (!scope) return;
      const targets = scope.querySelectorAll ? scope.querySelectorAll('textarea') : [scope];
      targets.forEach(ta => {
        ta.addEventListener('input', () => autoResizeTextarea(ta));
        // 少し遅らせて実行（描画待ち）
        setTimeout(() => autoResizeTextarea(ta), 10);
      });
    }

    // --- 行操作関数 ---
    function addSessionRow(data = {}) {
      if (!sessionBody) return;
      const tr = document.createElement('tr');
      tr.innerHTML = `
            <td><input type="date" name="sess_date" value="${data.date || ''}"></td>
            <td><textarea name="sess_title" rows="1">${data.title || ''}</textarea></td>
            <td><input type="number" name="sess_money" value="${data.money || 0}" class="calc-trigger"></td>
            <td><input type="number" name="sess_fame" value="${data.fame || 0}" class="calc-trigger"></td>
            <td><textarea name="sess_memo" rows="1">${data.memo || ''}</textarea></td>
            <td class="delete-cell"><button type="button" class="delete-row-btn"><i class="fa-solid fa-trash"></i></button></td>
        `;
      tr.querySelector('.delete-row-btn').addEventListener('click', () => { tr.remove(); calculateTotal(); });
      tr.querySelectorAll('.calc-trigger').forEach(el => el.addEventListener('input', calculateTotal));
      sessionBody.appendChild(tr);
      setupTextareaAutoResize(tr);
    }

    function addPurchaseRow(data = {}) {
      if (!purchaseBody) return;
      const tr = document.createElement('tr');
      tr.innerHTML = `
            <td><textarea name="pur_item" rows="1">${data.item || ''}</textarea></td>
            <td><input type="number" name="pur_cost" value="${data.cost || 0}" class="calc-trigger"></td>
            <td><textarea name="pur_memo" rows="1">${data.memo || ''}</textarea></td>
            <td class="delete-cell"><button type="button" class="delete-row-btn"><i class="fa-solid fa-trash"></i></button></td>
        `;
      tr.querySelector('.delete-row-btn').addEventListener('click', () => { tr.remove(); calculateTotal(); });
      tr.querySelectorAll('.calc-trigger').forEach(el => el.addEventListener('input', calculateTotal));
      purchaseBody.appendChild(tr);
      setupTextareaAutoResize(tr);
    }

    function addFameRow(data = {}) {
      if (!fameBody) return;
      const tr = document.createElement('tr');
      tr.innerHTML = `
            <td><input type="text" name="fame_name" value="${data.name || ''}" placeholder="技能名"></td>
            <td><textarea name="fame_effect" rows="1" placeholder="効果">${data.effect || ''}</textarea></td>
        `;
      fameBody.appendChild(tr);
      setupTextareaAutoResize(tr);
    }

    // --- 自動計算 ---
    function calculateTotal() {
      if (!sessionBody || !purchaseBody || !fameBody) return;

      // 初期値
      let totalMoney = parseInt(initMoneyInput ? initMoneyInput.value : 0) || 0;
      let totalFame = parseInt(initFameInput ? initFameInput.value : 0) || 0;

      // 1. セッション履歴 (報酬)
      sessionBody.querySelectorAll('tr').forEach(tr => {
        const m = parseInt(tr.querySelector('input[name="sess_money"]').value) || 0;
        const f = parseInt(tr.querySelector('input[name="sess_fame"]').value) || 0;
        totalMoney += m;
        totalFame += f;
      });

      // 2. その他収支 (購入・売却など)
      purchaseBody.querySelectorAll('tr').forEach(tr => {
        const c = parseInt(tr.querySelector('input[name="pur_cost"]').value) || 0;
        totalMoney += c;
      });

      // 3. ★追加: 装備品の購入費 (無料チェックがない場合のみ引く)
      const calcEquipCost = (priceInput, freeCheck) => {
        if (freeCheck && freeCheck.checked) return 0;
        return parseInt(priceInput.value) || 0;
      };

      // 右手
      totalMoney -= calcEquipCost(
        document.querySelector('input[name="equip_r_price"]'),
        document.querySelector('input[name="equip_r_free"]')
      );
      // 左手
      totalMoney -= calcEquipCost(
        document.querySelector('input[name="equip_l_price"]'),
        document.querySelector('input[name="equip_l_free"]')
      );
      // 胴
      totalMoney -= calcEquipCost(
        document.querySelector('input[name="equip_b_price"]'),
        document.querySelector('input[name="equip_b_free"]')
      );

      // 4. ★追加: 所持品リストの購入費
      const itemListRows = document.querySelectorAll('#item-list tbody tr');
      itemListRows.forEach(tr => {
        const priceInput = tr.querySelector('input[name="item_price"]');
        const freeCheck = tr.querySelector('input[name="item_free"]');
        if (priceInput && freeCheck && !freeCheck.checked) {
          totalMoney -= (parseInt(priceInput.value) || 0);
        }
      });

      // 反映
      if (moneyInput) moneyInput.value = totalMoney;
      if (fameInput) fameInput.value = totalFame;
      if (totalRewardsSpan) totalRewardsSpan.textContent = totalMoney;
      if (totalFameSpan) totalFameSpan.textContent = totalFame;

      // 名声技能枠計算
      let maxSkills = 0;
      if (totalFame >= 1500) maxSkills = 4 + Math.floor((totalFame - 1500) / 500);
      else if (totalFame >= 1000) maxSkills = 3;
      else if (totalFame >= 700) maxSkills = 2;
      else if (totalFame >= 200) maxSkills = 1;

      if (fameMaxSpan) fameMaxSpan.textContent = maxSkills;

      const currentCount = fameBody.querySelectorAll('tr').length;
      if (fameCountSpan) fameCountSpan.textContent = currentCount;

      // 枠調整
      if (currentCount < maxSkills) {
        const diff = maxSkills - currentCount;
        for (let i = 0; i < diff; i++) addFameRow();
      } else if (currentCount > maxSkills) {
        const rows = Array.from(fameBody.querySelectorAll('tr'));
        for (let i = rows.length - 1; i >= maxSkills; i--) {
          const row = rows[i];
          const name = row.querySelector('input[name="fame_name"]').value.trim();
          const effect = row.querySelector('textarea[name="fame_effect"]').value.trim();
          if (!name && !effect) row.remove();
        }
      }

      // 赤字判定
      if (fameCountSpan) {
        const finalCount = fameBody.querySelectorAll('tr').length;
        fameCountSpan.textContent = finalCount;
        fameCountSpan.style.color = (finalCount > maxSkills) ? '#ff5555' : '#fff';
      }
    }

    // --- ヘルパー: tbody取得 (なければ作る) ---
    function getTbodySafe(tableId) {
      const table = document.getElementById(tableId);
      if (!table) return null;
      let tbody = table.querySelector('tbody');
      if (!tbody) {
        tbody = document.createElement('tbody');
        table.appendChild(tbody);
      }
      return tbody;
    }

    // --- 初期化処理 ---
    window.addEventListener('DOMContentLoaded', () => {
      form = document.getElementById('shinjuku-sheet');
      idInput = document.getElementById('character-id');

      // 安全にtbodyを取得
      sessionBody = getTbodySafe('session-history');
      purchaseBody = getTbodySafe('purchase-history');
      fameBody = getTbodySafe('fame-skills-table');

      moneyInput = document.querySelector('input[name="money"]');
      fameInput = document.querySelector('input[name="fame_points"]');
      totalRewardsSpan = document.getElementById('total-rewards');
      totalFameSpan = document.getElementById('total-fame');
      fameCountSpan = document.getElementById('fame-count');
      fameMaxSpan = document.getElementById('fame-max');
      initMoneyInput = document.querySelector('input[name="init_money"]');
      initFameInput = document.querySelector('input[name="init_fame"]');

      // ボタンイベント設定
      const btnAddSession = document.getElementById('add-session-row');
      if (btnAddSession) btnAddSession.addEventListener('click', () => addSessionRow());

      const btnAddPurchase = document.getElementById('add-purchase-row');
      if (btnAddPurchase) btnAddPurchase.addEventListener('click', () => addPurchaseRow());

      // 初期値変更イベント
      if (initMoneyInput) initMoneyInput.addEventListener('input', calculateTotal);
      if (initFameInput) initFameInput.addEventListener('input', calculateTotal);

      // PL名復元
      const savedPlName = localStorage.getItem('shinjuku_pl_name');
      if (savedPlName && form) {
        const plInput = form.querySelector('input[name="player_name"]');
        if (plInput) plInput.value = savedPlName;
      }

      // 初期行の追加
      if (sessionBody && sessionBody.rows.length === 0) addSessionRow();
      if (purchaseBody && purchaseBody.rows.length === 0) addPurchaseRow();

      // 初回計算
      calculateTotal();
      setupTextareaAutoResize(document.body);

      // 折りたたみ(details)を開いた時にテキストエリアの高さを再調整
      document.querySelectorAll('details').forEach(details => {
        details.addEventListener('toggle', () => {
          if (details.open) {
            setTimeout(() => setupTextareaAutoResize(details), 10);
          }
        });
      });

      // URLパラメータ処理
      const urlParams = new URLSearchParams(window.location.search);
      const queryId = urlParams.get('id');
      const mode = urlParams.get('mode');

      // JSONモードの場合
      if (mode === 'json') {
        if (queryId) {
          loadFromServerAsJson(queryId);
        } else {
          displayJsonError('キャラクターIDが指定されていません');
        }
        return; // JSONモードの場合はここで終了
      }

      // 通常モード
      if (queryId && idInput) {
        idInput.value = queryId;
        loadFromServer(queryId, true);
      }
      // ★追加: 装備欄の入力変更時に再計算
      const equipInputs = document.querySelectorAll('.equipment input');
      equipInputs.forEach(el => el.addEventListener('input', calculateTotal));

      // 初期表示時にタブタイトルを更新
      updatePageTitle();

      if (typeof fetchCharacterList === 'function') fetchCharacterList();
    });

    // タブタイトル更新関数
    function updatePageTitle() {
      const pcName = document.querySelector('input[name="pc_name"]')?.value.trim();
      const baseTitle = 'シンジュクロウラー 探索者シート | 卓スタダ';

      if (pcName) {
        document.title = `${pcName} - ${baseTitle}`;
      } else {
        document.title = baseTitle;
      }
    }

    // JSON出力用: データを読み込んでJSON表示
    async function loadFromServerAsJson(charId) {
      try {
        const res = await fetch(`${GAS_API_URL}?tool=shinjuku&action=load&id=${encodeURIComponent(charId)}`);
        const json = await res.json();

        if (json.status === 'success') {
          const data = json.data;

          // JSON出力用のデータを整形
          const outputData = {
            characterId: charId,
            pcName: data.pc_name || '',
            playerName: data.player_name || '',
            kana: data.pc_kana || '',
            age: data.age || '',
            gender: data.gender || '',
            background: data.background || '',
            tags: data.tags || '',
            motivation: data.motivation || '',
            memo: data.memo || '',
            stamina: data.stamina || 0,
            spirit: data.spirit || 0,
            money: data.money || 0,
            famePoints: data.fame_points || 0
          };

          displayJson(outputData);
        } else {
          displayJsonError(json.message || 'データが見つかりませんでした');
        }
      } catch (e) {
        displayJsonError('データの読み込みに失敗しました: ' + e.message);
      }
    }

    // JSONを表示
    function displayJson(data) {
      document.body.innerHTML = `<pre style="font-family: monospace; white-space: pre-wrap; padding: 20px; background: #1a1a1a; color: #0f0;">${JSON.stringify(data, null, 2)}</pre>`;
      document.title = `${data.pcName || 'JSON'} - シンジュクロウラー JSON`;
    }

    // JSONエラー表示
    function displayJsonError(message) {
      document.body.innerHTML = `<pre style="font-family: monospace; white-space: pre-wrap; padding: 20px; background: #1a1a1a; color: #f00;">${JSON.stringify({ error: message }, null, 2)}</pre>`;
      document.title = 'Error - シンジュクロウラー JSON';
    }

    // --- データ取得 ---
    function getFormDataAsJson() {
      const formData = new FormData(form);
      const data = {};

      // フォーム内データの取得
      formData.forEach((value, key) => {
        if (!key.startsWith('sess_') && !key.startsWith('pur_') && !key.startsWith('fame_')) {
          data[key] = value;
        }
      });

      // ★追加: ヘッダー内のステータス（フォーム外）を手動取得
      // これらのinputは <header> 内にあるため form に含まれていない
      const staminaInput = document.querySelector('input[name="stamina"]');
      const spiritInput = document.querySelector('input[name="spirit"]');
      const moneyInput = document.querySelector('input[name="money"]'); // 計算結果だが保存しておくと安心
      const fameInput = document.querySelector('input[name="fame_points"]');

      if (staminaInput) data['stamina'] = staminaInput.value;
      if (spiritInput) data['spirit'] = spiritInput.value;
      if (moneyInput) data['money'] = moneyInput.value;
      if (fameInput) data['fame_points'] = fameInput.value;


      // パズル用: 所持品リストの行数
      const tbodyList = document.querySelector('#item-list tbody');
      data['__item_rows'] = tbodyList ? tbodyList.rows.length : 0;

      data['session_history'] = [];
      if (sessionBody) {
        sessionBody.querySelectorAll('tr').forEach(tr => {
          data['session_history'].push({
            date: tr.querySelector('input[name="sess_date"]').value,
            title: tr.querySelector('textarea[name="sess_title"]').value,
            money: tr.querySelector('input[name="sess_money"]').value,
            fame: tr.querySelector('input[name="sess_fame"]').value,
            memo: tr.querySelector('textarea[name="sess_memo"]').value
          });
        });
      }

      data['purchase_history'] = [];
      if (purchaseBody) {
        purchaseBody.querySelectorAll('tr').forEach(tr => {
          data['purchase_history'].push({
            item: tr.querySelector('textarea[name="pur_item"]').value,
            cost: tr.querySelector('input[name="pur_cost"]').value,
            memo: tr.querySelector('textarea[name="pur_memo"]').value
          });
        });
      }

      data['fame_skills_list'] = [];
      if (fameBody) {
        fameBody.querySelectorAll('tr').forEach(tr => {
          data['fame_skills_list'].push({
            name: tr.querySelector('input[name="fame_name"]').value,
            effect: tr.querySelector('textarea[name="fame_effect"]').value
          });
        });
      }
      return data;
    }

    // --- データ反映 ---
    function applyDataToSheet(data) {
      // 所持品リスト復元
      if (data['__item_rows']) {
        const tbodyList = document.querySelector('#item-list tbody');
        if (tbodyList) {
          const current = tbodyList.rows.length;
          const needed = parseInt(data['__item_rows']);
          for (let i = current; i < needed; i++) {
            document.getElementById('add-item-row').click();
          }
        }
      }

      // 履歴復元
      if (sessionBody) {
        sessionBody.innerHTML = '';
        if (data['session_history'] && data['session_history'].length > 0) {
          data['session_history'].forEach(row => addSessionRow(row));
        } else {
          addSessionRow();
        }
      }

      if (purchaseBody) {
        purchaseBody.innerHTML = '';
        if (data['purchase_history'] && data['purchase_history'].length > 0) {
          data['purchase_history'].forEach(row => addPurchaseRow(row));
        } else {
          addPurchaseRow();
        }
      }

      // 名声技能復元
      if (fameBody) {
        fameBody.innerHTML = '';
        if (data['fame_skills_list'] && data['fame_skills_list'].length > 0) {
          data['fame_skills_list'].forEach(row => addFameRow(row));
        } else if (data['fame_skills']) {
          addFameRow({ name: '旧データ', effect: data['fame_skills'] });
        }
      }

      // フォーム値復元
      Object.keys(data).forEach(key => {
        if (!['__item_rows', 'puzzle_positions', 'session_history', 'purchase_history', 'fame_skills_list'].includes(key)) {
          // フォーム内の要素を探す
          const el = form.elements[key];
          if (el) {
            el.value = data[key];
          } else {
            // フォーム外（ヘッダーなど）にある要素を探してセット
            const headerEl = document.querySelector(`input[name="${key}"]`);
            if (headerEl) {
              headerEl.value = data[key];
            }
          }
        }
      });

      if (window.restorePuzzle && data['puzzle_positions']) window.restorePuzzle(data['puzzle_positions']);

      calculateTotal();
      updatePageTitle(); // タブタイトルを更新
      setTimeout(() => setupTextareaAutoResize(document.body), 50);
    }

    // --- ボタン処理 ---
    document.getElementById('btn-save-server').addEventListener('click', async () => {
      const charId = idInput.value.trim();
      const isPrivate = document.getElementById('is-private').checked;
      if (!charId) { alert('IDを入力してください'); return; }

      localStorage.setItem('shinjuku_pl_name', document.querySelector('input[name="player_name"]').value);
      const btn = document.getElementById('btn-save-server');
      btn.disabled = true;
      btn.classList.add('loading');
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 保存中...';

      try {
        await fetch(GAS_API_URL, {
          method: 'POST', mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ tool: "shinjuku", action: "save", id: charId, data: getFormDataAsJson(), isPrivate })
        });
        alert('保存しました');

        // ★追加: URLパラメータを更新してリロードなしでURL変更
        const newUrl = `${window.location.pathname}?id=${encodeURIComponent(charId)}`;
        window.history.pushState({ path: newUrl }, '', newUrl);

        // 保存成功時にタブタイトルを更新
        updatePageTitle();

        setTimeout(fetchCharacterList, 2000);
      } catch (e) { alert('保存失敗: ' + e); }
      finally {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> 保存';
      }
    });

    // ココフォリア出力 (フォールバック付き)
    document.getElementById("btn-copy-ccfolia").addEventListener("click", () => {
      const pcName = document.querySelector('input[name="pc_name"]').value.trim();
      if (!pcName) { alert("PC名を入力してください"); return; }

      const formData = getFormDataAsJson();
      const penaltyDisplay = document.getElementById('penalty-display');
      const penalty = penaltyDisplay ? (penaltyDisplay.textContent.match(/-?\d+/) || [0])[0] : 0;
      const penaltyAbs = Math.abs(parseInt(penalty));
      const stamina = formData.stamina || 0;
      const spirit = formData.spirit || 0;
      const money = formData.money || 0;

      const equipBStat = document.querySelector('input[name="equip_b_stat"]').value;
      let armorDurability = 0;
      if (equipBStat && /\d+/.test(equipBStat)) armorDurability = parseInt(equipBStat.match(/\d+/)[0]);

      const statusList = [
        { label: "体力", value: stamina, max: 6 },
        { label: "やる気", value: spirit, max: 6 },
        { label: "所持金", value: money },
        { label: "ペナルティ", value: penaltyAbs }
      ];
      if (armorDurability > 0) statusList.push({ label: "防具", value: armorDurability, max: armorDurability });

      // 装備情報を取得
      const equipR = {
        name: document.querySelector('input[name="equip_r_name"]').value.trim(),
        stat: document.querySelector('input[name="equip_r_stat"]').value.trim(),
        note: document.querySelector('textarea[name="equip_r_note"]').value.trim()
      };
      const equipL = {
        name: document.querySelector('input[name="equip_l_name"]').value.trim(),
        stat: document.querySelector('input[name="equip_l_stat"]').value.trim(),
        note: document.querySelector('textarea[name="equip_l_note"]').value.trim()
      };
      const equipB = {
        name: document.querySelector('input[name="equip_b_name"]').value.trim(),
        stat: document.querySelector('input[name="equip_b_stat"]').value.trim(),
        note: document.querySelector('textarea[name="equip_b_note"]').value.trim()
      };

      // memoに装備情報を追加
      let memoText = formData.memo || "";
      const equipmentLines = [];

      if (equipR.name) {
        let rLine = `右手: ${equipR.name}`;
        if (equipR.stat) rLine += ` (${equipR.stat})`;
        if (equipR.note) rLine += ` - ${equipR.note}`;
        equipmentLines.push(rLine);
      }
      if (equipL.name) {
        let lLine = `左手: ${equipL.name}`;
        if (equipL.stat) lLine += ` (${equipL.stat})`;
        if (equipL.note) lLine += ` - ${equipL.note}`;
        equipmentLines.push(lLine);
      }
      if (equipB.name) {
        let bLine = `胴: ${equipB.name}`;
        if (equipB.stat) bLine += ` (${equipB.stat})`;
        if (equipB.note) bLine += ` - ${equipB.note}`;
        equipmentLines.push(bLine);
      }

      if (equipmentLines.length > 0) {
        if (memoText) memoText += "\n\n";
        memoText += "【装備】\n" + equipmentLines.join("\n");
      }

      // externalUrlを現在のURLに設定
      const charId = idInput.value.trim();
      let externalUrl = "";
      if (charId) {
        externalUrl = `${location.protocol}//${location.host}${location.pathname}?id=${encodeURIComponent(charId)}`;
      }

      const ccfoliaData = {
        kind: "character",
        data: {
          name: pcName,
          memo: memoText,
          initiative: 0,
          externalUrl: externalUrl,
          status: statusList,
          commands: generateChatPalette(formData, penalty)
        },
      };

      const jsonString = JSON.stringify(ccfoliaData);
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(jsonString)
          .then(() => alert("ココフォリア駒データをコピーしました！\n盤面で貼り付けてください。"))
          .catch(err => fallbackCopyTextToClipboard(jsonString));
      } else {
        fallbackCopyTextToClipboard(jsonString);
      }
    });

    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed";
      textArea.style.left = "-9999px";
      document.body.appendChild(textArea);
      textArea.focus(); textArea.select();
      try {
        const s = document.execCommand('copy');
        alert(s ? "ココフォリア駒データをコピーしました！(互換)" : "コピー失敗");
      } catch (e) { alert("コピー失敗"); }
      document.body.removeChild(textArea);
    }

    async function loadFromServer(charId, isAuto) {
      if (!charId) return;

      // ローディングオーバーレイを表示
      const loadingOverlay = document.getElementById('loading-overlay');
      if (loadingOverlay) loadingOverlay.style.display = 'flex';

      try {
        const res = await fetch(`${GAS_API_URL}?tool=shinjuku&action=load&id=${encodeURIComponent(charId)}`);
        const json = await res.json();
        if (json.status === 'success') {
          if (isAuto || confirm('読み込みますか？')) {
            applyDataToSheet(json.data);
            // ★追加: 読み込み成功時にURLを更新する
            const newUrl = `${window.location.pathname}?id=${encodeURIComponent(charId)}`;
            window.history.pushState({ path: newUrl }, '', newUrl);
          }
        } else {
          if (!isAuto) alert(json.message);
        }
      } catch (e) {
        if (!isAuto) alert(e);
      } finally {
        // ローディングオーバーレイを非表示
        if (loadingOverlay) loadingOverlay.style.display = 'none';
      }
    }


    document.getElementById('btn-share').addEventListener('click', () => {
      const id = idInput.value.trim();
      if (!id) return alert('IDを入力してください');
      const url = `${location.protocol}//${location.host}${location.pathname}?id=${encodeURIComponent(id)}`;
      navigator.clipboard.writeText(url).then(() => alert('コピーしました: ' + url));
    });

    document.getElementById('btn-reset').addEventListener('click', () => {
      if (!confirm('リセットしますか？')) return;
      form.reset();
      if (window.restorePuzzle) window.restorePuzzle('[]');
      if (sessionBody) { sessionBody.innerHTML = ''; addSessionRow(); }
      if (purchaseBody) { purchaseBody.innerHTML = ''; addPurchaseRow(); }
      if (fameBody) { fameBody.innerHTML = ''; }
      calculateTotal();
    });

    // --- 一覧取得機能 ---
    document.getElementById('btn-refresh-list').addEventListener('click', fetchCharacterList);

    async function fetchCharacterList() {
      const tbody = document.getElementById('character-list-body');
      if (!tbody) return;
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">読み込み中...</td></tr>';

      try {
        const url = `${GAS_API_URL}?tool=shinjuku&action=list`;
        const response = await fetch(url);
        const json = await response.json();

        if (json.status === 'success') {
          const list = json.data;
          if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">データなし</td></tr>';
            return;
          }
          tbody.innerHTML = '';
          list.forEach(c => {
            const tr = document.createElement('tr');
            const link = `?id=${encodeURIComponent(c.id)}`;
            tr.innerHTML = `<td><b>${escapeHtml(c.pc_name)}</b></td><td>${escapeHtml(c.player_name)}</td><td>${c.updated}</td><td style="text-align:center;"><a href="${link}" class="crawler-btn load" style="padding:2px 8px;font-size:0.8em">見る</a></td>`;
            tbody.appendChild(tr);
          });
        } else {
          tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:red;">${json.message}</td></tr>`;
        }
      } catch (e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:red;">エラー</td></tr>';
      }
    }

    function generateChatPalette(data, penalty) {
      const spirit = data.spirit || 0;
      const equipR = {
        name: document.querySelector('input[name="equip_r_name"]').value,
        stat: document.querySelector('input[name="equip_r_stat"]').value
      };
      const equipL = {
        name: document.querySelector('input[name="equip_l_name"]').value,
        stat: document.querySelector('input[name="equip_l_stat"]').value
      };

      const palette = [];
      palette.push(`//-- 判定 --`);
      palette.push(`1d6 先制判定 (1-3:先手 / 4-6:後手)`);
      palette.push(`choice[敵より前,敵より後] 行動順`);
      palette.push(`D6>={やる気} やる気判定`);
      palette.push(``);

      palette.push(`//-- 攻撃 --`);
      if (equipR.name && equipR.stat) palette.push(`${equipR.stat} ダメージ／${equipR.name}`);
      if (equipL.name && equipL.stat) palette.push(`${equipL.stat} ダメージ／${equipL.name}`);

      palette.push(`D20<=11-{ペナルティ} 攻撃判定`);
      palette.push(`2D20L1<=11-{ペナルティ} 有利・攻撃判定`);
      palette.push(`2D20H1<=11-{ペナルティ} 不利・攻撃判定`);
      palette.push(``);

      palette.push(`//-- 汎用判定 --`);
      palette.push(`D20<={成功値}-{ペナルティ} 判定`);

      return palette.join('\n');
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
    }
  </script>
</body>

</html>